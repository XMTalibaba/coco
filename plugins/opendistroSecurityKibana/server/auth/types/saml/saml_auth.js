"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SamlAuthentication = void 0;

var _querystring = require("querystring");

var _security_cookie = require("../../../session/security_cookie");

var _routes = require("./routes");

var _authentication_type = require("../authentication_type");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class SamlAuthentication extends _authentication_type.AuthenticationType {
  constructor(config, sessionStorageFactory, router, esClient, coreSetup, logger) {
    super(config, sessionStorageFactory, router, esClient, coreSetup, logger);

    _defineProperty(this, "type", 'saml');

    this.setupRoutes();
  }

  generateNextUrl(request) {
    const path = this.coreSetup.http.basePath.serverBasePath + (request.url.path || '/app/kibana');
    return (0, _querystring.escape)(path);
  }

  redirectToLoginUri(request, toolkit) {
    const nextUrl = this.generateNextUrl(request);
    const clearOldVersionCookie = (0, _security_cookie.clearOldVersionCookieValue)(this.config);
    return toolkit.redirected({
      location: `${this.coreSetup.http.basePath.serverBasePath}/auth/saml/login?nextUrl=${nextUrl}`,
      'set-cookie': clearOldVersionCookie
    });
  }

  setupRoutes() {
    const samlAuthRoutes = new _routes.SamlAuthRoutes(this.router, this.config, this.sessionStorageFactory, this.securityClient, this.coreSetup);
    samlAuthRoutes.setupRoutes();
  }

  requestIncludesAuthInfo(request) {
    return request.headers[SamlAuthentication.AUTH_HEADER_NAME] ? true : false;
  }

  getAdditionalAuthHeader(request) {
    return {};
  }

  getCookie(request, authInfo) {
    return {
      username: authInfo.user_name,
      credentials: {
        authHeaderValue: request.headers[SamlAuthentication.AUTH_HEADER_NAME]
      },
      authType: this.type,
      expiryTime: Date.now() + this.config.session.ttl
    };
  }

  async isValidCookie(cookie) {
    var _cookie$credentials;

    return cookie.authType === this.type && cookie.username && cookie.expiryTime && ((_cookie$credentials = cookie.credentials) === null || _cookie$credentials === void 0 ? void 0 : _cookie$credentials.authHeaderValue);
  }

  handleUnauthedRequest(request, response, toolkit) {
    if (this.isPageRequest(request)) {
      return this.redirectToLoginUri(request, toolkit);
    } else {
      return response.unauthorized();
    }
  }

  buildAuthHeaderFromCookie(cookie) {
    var _cookie$credentials2;

    const headers = {};
    headers[SamlAuthentication.AUTH_HEADER_NAME] = (_cookie$credentials2 = cookie.credentials) === null || _cookie$credentials2 === void 0 ? void 0 : _cookie$credentials2.authHeaderValue;
    return headers;
  }

}

exports.SamlAuthentication = SamlAuthentication;

_defineProperty(SamlAuthentication, "AUTH_HEADER_NAME", 'authorization');
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNhbWxfYXV0aC50cyJdLCJuYW1lcyI6WyJTYW1sQXV0aGVudGljYXRpb24iLCJBdXRoZW50aWNhdGlvblR5cGUiLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsInNlc3Npb25TdG9yYWdlRmFjdG9yeSIsInJvdXRlciIsImVzQ2xpZW50IiwiY29yZVNldHVwIiwibG9nZ2VyIiwic2V0dXBSb3V0ZXMiLCJnZW5lcmF0ZU5leHRVcmwiLCJyZXF1ZXN0IiwicGF0aCIsImh0dHAiLCJiYXNlUGF0aCIsInNlcnZlckJhc2VQYXRoIiwidXJsIiwicmVkaXJlY3RUb0xvZ2luVXJpIiwidG9vbGtpdCIsIm5leHRVcmwiLCJjbGVhck9sZFZlcnNpb25Db29raWUiLCJyZWRpcmVjdGVkIiwibG9jYXRpb24iLCJzYW1sQXV0aFJvdXRlcyIsIlNhbWxBdXRoUm91dGVzIiwic2VjdXJpdHlDbGllbnQiLCJyZXF1ZXN0SW5jbHVkZXNBdXRoSW5mbyIsImhlYWRlcnMiLCJBVVRIX0hFQURFUl9OQU1FIiwiZ2V0QWRkaXRpb25hbEF1dGhIZWFkZXIiLCJnZXRDb29raWUiLCJhdXRoSW5mbyIsInVzZXJuYW1lIiwidXNlcl9uYW1lIiwiY3JlZGVudGlhbHMiLCJhdXRoSGVhZGVyVmFsdWUiLCJhdXRoVHlwZSIsInR5cGUiLCJleHBpcnlUaW1lIiwiRGF0ZSIsIm5vdyIsInNlc3Npb24iLCJ0dGwiLCJpc1ZhbGlkQ29va2llIiwiY29va2llIiwiaGFuZGxlVW5hdXRoZWRSZXF1ZXN0IiwicmVzcG9uc2UiLCJpc1BhZ2VSZXF1ZXN0IiwidW5hdXRob3JpemVkIiwiYnVpbGRBdXRoSGVhZGVyRnJvbUNvb2tpZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQWVBOztBQWNBOztBQUlBOztBQUNBOzs7O0FBRU8sTUFBTUEsa0JBQU4sU0FBaUNDLHVDQUFqQyxDQUFvRDtBQUt6REMsRUFBQUEsV0FBVyxDQUNUQyxNQURTLEVBRVRDLHFCQUZTLEVBR1RDLE1BSFMsRUFJVEMsUUFKUyxFQUtUQyxT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OztBQUM1RCxVQUFNakIsT0FBWSxHQUFHLEVBQXJCO0FBQ0FBLElBQUFBLE9BQU8sQ0FBQzNCLGtCQUFrQixDQUFDNEIsZ0JBQXBCLENBQVAsMkJBQStDZ0IsTUFBTSxDQUFDVixXQUF0RCx5REFBK0MscUJBQW9CQyxlQUFuRTtBQUNBLFdBQU9SLE9BQVA7QUFDRDs7QUF0RndEOzs7O2dCQUE5QzNCLGtCLHNCQUMrQixlIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqICAgQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiAgIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqICAgQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgIG9yIGluIHRoZSBcImxpY2Vuc2VcIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZFxuICogICBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqICAgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqICAgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IGVzY2FwZSB9IGZyb20gJ3F1ZXJ5c3RyaW5nJztcbmltcG9ydCB7IENvcmVTZXR1cCB9IGZyb20gJ2tpYmFuYS9zZXJ2ZXInO1xuaW1wb3J0IHsgU2VjdXJpdHlQbHVnaW5Db25maWdUeXBlIH0gZnJvbSAnLi4vLi4vLi4nO1xuaW1wb3J0IHtcbiAgU2Vzc2lvblN0b3JhZ2VGYWN0b3J5LFxuICBJUm91dGVyLFxuICBJTGVnYWN5Q2x1c3RlckNsaWVudCxcbiAgS2liYW5hUmVxdWVzdCxcbiAgQXV0aFRvb2xraXQsXG4gIExvZ2dlcixcbiAgTGlmZWN5Y2xlUmVzcG9uc2VGYWN0b3J5LFxuICBJS2liYW5hUmVzcG9uc2UsXG4gIEF1dGhSZXN1bHQsXG59IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3NlcnZlcic7XG5pbXBvcnQge1xuICBTZWN1cml0eVNlc3Npb25Db29raWUsXG4gIGNsZWFyT2xkVmVyc2lvbkNvb2tpZVZhbHVlLFxufSBmcm9tICcuLi8uLi8uLi9zZXNzaW9uL3NlY3VyaXR5X2Nvb2tpZSc7XG5pbXBvcnQgeyBTYW1sQXV0aFJvdXRlcyB9IGZyb20gJy4vcm91dGVzJztcbmltcG9ydCB7IEF1dGhlbnRpY2F0aW9uVHlwZSB9IGZyb20gJy4uL2F1dGhlbnRpY2F0aW9uX3R5cGUnO1xuXG5leHBvcnQgY2xhc3MgU2FtbEF1dGhlbnRpY2F0aW9uIGV4dGVuZHMgQXV0aGVudGljYXRpb25UeXBlIHtcbiAgcHVibGljIHN0YXRpYyByZWFkb25seSBBVVRIX0hFQURFUl9OQU1FID0gJ2F1dGhvcml6YXRpb24nO1xuXG4gIHB1YmxpYyByZWFkb25seSB0eXBlOiBzdHJpbmcgPSAnc2FtbCc7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgY29uZmlnOiBTZWN1cml0eVBsdWdpbkNvbmZpZ1R5cGUsXG4gICAgc2Vzc2lvblN0b3JhZ2VGYWN0b3J5OiBTZXNzaW9uU3RvcmFnZUZhY3Rvcnk8U2VjdXJpdHlTZXNzaW9uQ29va2llPixcbiAgICByb3V0ZXI6IElSb3V0ZXIsXG4gICAgZXNDbGllbnQ6IElMZWdhY3lDbHVzdGVyQ2xpZW50LFxuICAgIGNvcmVTZXR1cDogQ29yZVNldHVwLFxuICAgIGxvZ2dlcjogTG9nZ2VyXG4gICkge1xuICAgIHN1cGVyKGNvbmZpZywgc2Vzc2lvblN0b3JhZ2VGYWN0b3J5LCByb3V0ZXIsIGVzQ2xpZW50LCBjb3JlU2V0dXAsIGxvZ2dlcik7XG4gICAgdGhpcy5zZXR1cFJvdXRlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU5leHRVcmwocmVxdWVzdDogS2liYW5hUmVxdWVzdCk6IHN0cmluZyB7XG4gICAgY29uc3QgcGF0aCA9IHRoaXMuY29yZVNldHVwLmh0dHAuYmFzZVBhdGguc2VydmVyQmFzZVBhdGggKyAocmVxdWVzdC51cmwucGF0aCB8fCAnL2FwcC9raWJhbmEnKTtcbiAgICByZXR1cm4gZXNjYXBlKHBhdGgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWRpcmVjdFRvTG9naW5VcmkocmVxdWVzdDogS2liYW5hUmVxdWVzdCwgdG9vbGtpdDogQXV0aFRvb2xraXQpIHtcbiAgICBjb25zdCBuZXh0VXJsID0gdGhpcy5nZW5lcmF0ZU5leHRVcmwocmVxdWVzdCk7XG4gICAgY29uc3QgY2xlYXJPbGRWZXJzaW9uQ29va2llID0gY2xlYXJPbGRWZXJzaW9uQ29va2llVmFsdWUodGhpcy5jb25maWcpO1xuICAgIHJldHVybiB0b29sa2l0LnJlZGlyZWN0ZWQoe1xuICAgICAgbG9jYXRpb246IGAke3RoaXMuY29yZVNldHVwLmh0dHAuYmFzZVBhdGguc2VydmVyQmFzZVBhdGh9L2F1dGgvc2FtbC9sb2dpbj9uZXh0VXJsPSR7bmV4dFVybH1gLFxuICAgICAgJ3NldC1jb29raWUnOiBjbGVhck9sZFZlcnNpb25Db29raWUsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHNldHVwUm91dGVzKCk6IHZvaWQge1xuICAgIGNvbnN0IHNhbWxBdXRoUm91dGVzID0gbmV3IFNhbWxBdXRoUm91dGVzKFxuICAgICAgdGhpcy5yb3V0ZXIsXG4gICAgICB0aGlzLmNvbmZpZyxcbiAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2VGYWN0b3J5LFxuICAgICAgdGhpcy5zZWN1cml0eUNsaWVudCxcbiAgICAgIHRoaXMuY29yZVNldHVwXG4gICAgKTtcbiAgICBzYW1sQXV0aFJvdXRlcy5zZXR1cFJvdXRlcygpO1xuICB9XG5cbiAgcmVxdWVzdEluY2x1ZGVzQXV0aEluZm8ocmVxdWVzdDogS2liYW5hUmVxdWVzdCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiByZXF1ZXN0LmhlYWRlcnNbU2FtbEF1dGhlbnRpY2F0aW9uLkFVVEhfSEVBREVSX05BTUVdID8gdHJ1ZSA6IGZhbHNlO1xuICB9XG5cbiAgZ2V0QWRkaXRpb25hbEF1dGhIZWFkZXIocmVxdWVzdDogS2liYW5hUmVxdWVzdCk6IGFueSB7XG4gICAgcmV0dXJuIHt9O1xuICB9XG5cbiAgZ2V0Q29va2llKHJlcXVlc3Q6IEtpYmFuYVJlcXVlc3QsIGF1dGhJbmZvOiBhbnkpOiBTZWN1cml0eVNlc3Npb25Db29raWUge1xuICAgIHJldHVybiB7XG4gICAgICB1c2VybmFtZTogYXV0aEluZm8udXNlcl9uYW1lLFxuICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgYXV0aEhlYWRlclZhbHVlOiByZXF1ZXN0LmhlYWRlcnNbU2FtbEF1dGhlbnRpY2F0aW9uLkFVVEhfSEVBREVSX05BTUVdLFxuICAgICAgfSxcbiAgICAgIGF1dGhUeXBlOiB0aGlzLnR5cGUsXG4gICAgICBleHBpcnlUaW1lOiBEYXRlLm5vdygpICsgdGhpcy5jb25maWcuc2Vzc2lvbi50dGwsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGlzVmFsaWRDb29raWUoY29va2llOiBTZWN1cml0eVNlc3Npb25Db29raWUpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gKFxuICAgICAgY29va2llLmF1dGhUeXBlID09PSB0aGlzLnR5cGUgJiZcbiAgICAgIGNvb2tpZS51c2VybmFtZSAmJlxuICAgICAgY29va2llLmV4cGlyeVRpbWUgJiZcbiAgICAgIGNvb2tpZS5jcmVkZW50aWFscz8uYXV0aEhlYWRlclZhbHVlXG4gICAgKTtcbiAgfVxuXG4gIGhhbmRsZVVuYXV0aGVkUmVxdWVzdChcbiAgICByZXF1ZXN0OiBLaWJhbmFSZXF1ZXN0LFxuICAgIHJlc3BvbnNlOiBMaWZlY3ljbGVSZXNwb25zZUZhY3RvcnksXG4gICAgdG9vbGtpdDogQXV0aFRvb2xraXRcbiAgKTogSUtpYmFuYVJlc3BvbnNlIHwgQXV0aFJlc3VsdCB7XG4gICAgaWYgKHRoaXMuaXNQYWdlUmVxdWVzdChyZXF1ZXN0KSkge1xuICAgICAgcmV0dXJuIHRoaXMucmVkaXJlY3RUb0xvZ2luVXJpKHJlcXVlc3QsIHRvb2xraXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVzcG9uc2UudW5hdXRob3JpemVkKCk7XG4gICAgfVxuICB9XG5cbiAgYnVpbGRBdXRoSGVhZGVyRnJvbUNvb2tpZShjb29raWU6IFNlY3VyaXR5U2Vzc2lvbkNvb2tpZSk6IGFueSB7XG4gICAgY29uc3QgaGVhZGVyczogYW55ID0ge307XG4gICAgaGVhZGVyc1tTYW1sQXV0aGVudGljYXRpb24uQVVUSF9IRUFERVJfTkFNRV0gPSBjb29raWUuY3JlZGVudGlhbHM/LmF1dGhIZWFkZXJWYWx1ZTtcbiAgICByZXR1cm4gaGVhZGVycztcbiAgfVxufVxuIl19