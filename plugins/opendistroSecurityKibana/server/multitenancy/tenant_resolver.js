"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.resolveTenant = resolveTenant;
exports.isMultitenantPath = isMultitenantPath;
exports.isValidTenant = isValidTenant;
exports.GLOBAL_TENANTS = exports.PRIVATE_TENANTS = void 0;

var _lodash = require("lodash");

/*
 *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *   Licensed under the Apache License, Version 2.0 (the "License").
 *   You may not use this file except in compliance with the License.
 *   A copy of the License is located at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   or in the "license" file accompanying this file. This file is distributed
 *   on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 *   express or implied. See the License for the specific language governing
 *   permissions and limitations under the License.
 */
const PRIVATE_TENANT_SYMBOL = '__user__';
const GLOBAL_TENANT_SYMBOL = '';
const PRIVATE_TENANTS = [PRIVATE_TENANT_SYMBOL, 'private'];
exports.PRIVATE_TENANTS = PRIVATE_TENANTS;
const GLOBAL_TENANTS = ['global', GLOBAL_TENANT_SYMBOL];
/**
 * Resovles the tenant the user is using.
 *
 * @param request Kibana request.
 * @param config security plugin config.
 * @param cookie cookie extracted from the request. The cookie should have been parsed by AuthenticationHandler.
 * pass it as parameter instead of extracting again.
 * @param authInfo authentication info, the Elasticsearch authinfo API response.
 *
 * @returns user preferred tenant of the request.
 */

exports.GLOBAL_TENANTS = GLOBAL_TENANTS;

function resolveTenant(request, username, availabeTenants, config, cookie) {
  var _config$multitenancy, _config$multitenancy2, _config$multitenancy3;

  let selectedTenant;
  const query = request.url.query;

  if (query && (query.security_tenant || query.securitytenant)) {
    selectedTenant = query.security_tenant ? query.security_tenant : query.securitytenant;
  } else if (request.headers.securitytenant || request.headers.security_tenant) {
    selectedTenant = request.headers.securitytenant ? request.headers.securitytenant : request.headers.security_tenant;
  } else if (isValidTenant(cookie.tenant)) {
    selectedTenant = cookie.tenant;
  } else {
    selectedTenant = undefined;
  }

  const preferredTenants = (_config$multitenancy = config.multitenancy) === null || _config$multitenancy === void 0 ? void 0 : _config$multitenancy.tenants.preferred;
  const globalTenantEnabled = ((_config$multitenancy2 = config.multitenancy) === null || _config$multitenancy2 === void 0 ? void 0 : _config$multitenancy2.tenants.enable_global) || false;
  const privateTenantEnabled = ((_config$multitenancy3 = config.multitenancy) === null || _config$multitenancy3 === void 0 ? void 0 : _config$multitenancy3.tenants.enable_private) || false;
  return resolve(username, selectedTenant, preferredTenants, availabeTenants, globalTenantEnabled, privateTenantEnabled);
}
/**
 * Determines whether the request requires tenant info.
 * @param request kibana request.
 *
 * @returns true if the request requires tenant info, otherwise false.
 */


function isMultitenantPath(request) {
  var _request$url$pathname, _request$url$pathname2, _request$url$pathname3, _request$url$pathname4, _request$url$pathname5;

  return ((_request$url$pathname = request.url.pathname) === null || _request$url$pathname === void 0 ? void 0 : _request$url$pathname.startsWith('/elasticsearch')) || ((_request$url$pathname2 = request.url.pathname) === null || _request$url$pathname2 === void 0 ? void 0 : _request$url$pathname2.startsWith('/api')) || ((_request$url$pathname3 = request.url.pathname) === null || _request$url$pathname3 === void 0 ? void 0 : _request$url$pathname3.startsWith('/app')) || ( // short url path
  (_request$url$pathname4 = request.url.pathname) === null || _request$url$pathname4 === void 0 ? void 0 : _request$url$pathname4.startsWith('/goto')) || // bootstrap.js depends on tenant info to fetch kibana configs in tenant index
  (((_request$url$pathname5 = request.url.pathname) === null || _request$url$pathname5 === void 0 ? void 0 : _request$url$pathname5.indexOf('bootstrap.js')) || -1) > -1 || request.url.pathname === '/';
}

function resolve(username, requestedTenant, preferredTenants, availableTenants, // is an object like { tenant_name_1: true, tenant_name_2: false, ... }
globalTenantEnabled, privateTenantEnabled) {
  const availableTenantsClone = (0, _lodash.cloneDeep)(availableTenants);
  delete availableTenantsClone[username];

  if (!globalTenantEnabled && !privateTenantEnabled && (0, _lodash.isEmpty)(availableTenantsClone)) {
    return undefined;
  }

  if (isValidTenant(requestedTenant)) {
    requestedTenant = requestedTenant;

    if (requestedTenant in availableTenants) {
      return requestedTenant;
    }

    if (privateTenantEnabled && username in availableTenants && PRIVATE_TENANTS.indexOf(requestedTenant) > -1) {
      return PRIVATE_TENANT_SYMBOL;
    }

    if (globalTenantEnabled && GLOBAL_TENANTS.indexOf(requestedTenant) > -1) {
      return GLOBAL_TENANT_SYMBOL;
    }
  }

  if (preferredTenants && !(0, _lodash.isEmpty)(preferredTenants)) {
    for (const element of preferredTenants) {
      const tenant = element.toLowerCase();

      if (globalTenantEnabled && GLOBAL_TENANTS.indexOf(tenant) > -1) {
        return GLOBAL_TENANT_SYMBOL;
      }

      if (privateTenantEnabled && PRIVATE_TENANTS.indexOf(tenant) > -1 && username in availableTenants) {
        return PRIVATE_TENANT_SYMBOL;
      }

      if (tenant in availableTenants) {
        return tenant;
      }
    }
  }

  if (globalTenantEnabled) {
    return GLOBAL_TENANT_SYMBOL;
  }

  if (privateTenantEnabled) {
    return PRIVATE_TENANT_SYMBOL;
  } // fall back to the first tenant in the available tenants


  return (0, _lodash.findKey)(availableTenantsClone, () => true);
}
/**
 * Return true if tenant parameter is a valid tenent.
 *
 * Note: empty string '' is valid, which means global tenant.
 *
 * @param tenant
 */


function isValidTenant(tenant) {
  return tenant !== undefined && tenant !== null;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlbmFudF9yZXNvbHZlci50cyJdLCJuYW1lcyI6WyJQUklWQVRFX1RFTkFOVF9TWU1CT0wiLCJHTE9CQUxfVEVOQU5UX1NZTUJPTCIsIlBSSVZBVEVfVEVOQU5UUyIsIkdMT0JBTF9URU5BTlRTIiwicmVzb2x2ZVRlbmFudCIsInJlcXVlc3QiLCJ1c2VybmFtZSIsImF2YWlsYWJlVGVuYW50cyIsImNvbmZpZyIsImNvb2tpZSIsInNlbGVjdGVkVGVuYW50IiwicXVlcnkiLCJ1cmwiLCJzZWN1cml0eV90ZW5hbnQiLCJzZWN1cml0eXRlbmFudCIsImhlYWRlcnMiLCJpc1ZhbGlkVGVuYW50IiwidGVuYW50IiwidW5kZWZpbmVkIiwicHJlZmVycmVkVGVuYW50cyIsIm11bHRpdGVuYW5jeSIsInRlbmFudHMiLCJwcmVmZXJyZWQiLCJnbG9iYWxUZW5hbnRFbmFibGVkIiwiZW5hYmxlX2dsb2JhbCIsInByaXZhdGVUZW5hbnRFbmFibGVkIiwiZW5hYmxlX3ByaXZhdGUiLCJyZXNvbHZlIiwiaXNNdWx0aXRlbmFudFBhdGgiLCJwYXRobmFtZSIsInN0YXJ0c1dpdGgiLCJpbmRleE9mIiwicmVxdWVzdGVkVGVuYW50IiwiYXZhaWxhYmxlVGVuYW50cyIsImF2YWlsYWJsZVRlbmFudHNDbG9uZSIsImVsZW1lbnQiLCJ0b0xvd2VyQ2FzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQWVBOztBQWZBOzs7Ozs7Ozs7Ozs7OztBQW9CQSxNQUFNQSxxQkFBNkIsR0FBRyxVQUF0QztBQUNBLE1BQU1DLG9CQUE0QixHQUFHLEVBQXJDO0FBRU8sTUFBTUMsZUFBeUIsR0FBRyxDQUFDRixxQkFBRCxFQUF3QixTQUF4QixDQUFsQzs7QUFDQSxNQUFNRyxjQUF3QixHQUFHLENBQUMsUUFBRCxFQUFXRixvQkFBWCxDQUFqQztBQUNQOzs7Ozs7Ozs7Ozs7OztBQVdPLFNBQVNHLGFBQVQsQ0FDTEMsT0FESyxFQUVMQyxRQUZLLEVBR0xDLGVBSEssRUFJTEMsTUFKSyxFQUtMQyxN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K0IsTUFBTSxJQUFyQyxDQUFQO0FBQ0Q7QUFFRDs7Ozs7Ozs7O0FBT08sU0FBU2xCLGFBQVQsQ0FBdUJDLE1BQXZCLEVBQW1FO0FBQ3hFLFNBQU9BLE1BQU0sS0FBS0MsU0FBWCxJQUF3QkQsTUFBTSxLQUFLLElBQTFDO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogICBDb3B5cmlnaHQgMjAyMCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbiAqICAgWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogICBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICAgb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiAgIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogICBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZ1xuICogICBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgaXNFbXB0eSwgZmluZEtleSwgY2xvbmVEZWVwIH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEtpYmFuYVJlcXVlc3QgfSBmcm9tICcuLi8uLi8uLi8uLi9zcmMvY29yZS9zZXJ2ZXInO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXNzaW9uQ29va2llIH0gZnJvbSAnLi4vc2Vzc2lvbi9zZWN1cml0eV9jb29raWUnO1xuaW1wb3J0IHsgU2VjdXJpdHlQbHVnaW5Db25maWdUeXBlIH0gZnJvbSAnLi4nO1xuXG5jb25zdCBQUklWQVRFX1RFTkFOVF9TWU1CT0w6IHN0cmluZyA9ICdfX3VzZXJfXyc7XG5jb25zdCBHTE9CQUxfVEVOQU5UX1NZTUJPTDogc3RyaW5nID0gJyc7XG5cbmV4cG9ydCBjb25zdCBQUklWQVRFX1RFTkFOVFM6IHN0cmluZ1tdID0gW1BSSVZBVEVfVEVOQU5UX1NZTUJPTCwgJ3ByaXZhdGUnXTtcbmV4cG9ydCBjb25zdCBHTE9CQUxfVEVOQU5UUzogc3RyaW5nW10gPSBbJ2dsb2JhbCcsIEdMT0JBTF9URU5BTlRfU1lNQk9MXTtcbi8qKlxuICogUmVzb3ZsZXMgdGhlIHRlbmFudCB0aGUgdXNlciBpcyB1c2luZy5cbiAqXG4gKiBAcGFyYW0gcmVxdWVzdCBLaWJhbmEgcmVxdWVzdC5cbiAqIEBwYXJhbSBjb25maWcgc2VjdXJpdHkgcGx1Z2luIGNvbmZpZy5cbiAqIEBwYXJhbSBjb29raWUgY29va2llIGV4dHJhY3RlZCBmcm9tIHRoZSByZXF1ZXN0LiBUaGUgY29va2llIHNob3VsZCBoYXZlIGJlZW4gcGFyc2VkIGJ5IEF1dGhlbnRpY2F0aW9uSGFuZGxlci5cbiAqIHBhc3MgaXQgYXMgcGFyYW1ldGVyIGluc3RlYWQgb2YgZXh0cmFjdGluZyBhZ2Fpbi5cbiAqIEBwYXJhbSBhdXRoSW5mbyBhdXRoZW50aWNhdGlvbiBpbmZvLCB0aGUgRWxhc3RpY3NlYXJjaCBhdXRoaW5mbyBBUEkgcmVzcG9uc2UuXG4gKlxuICogQHJldHVybnMgdXNlciBwcmVmZXJyZWQgdGVuYW50IG9mIHRoZSByZXF1ZXN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gcmVzb2x2ZVRlbmFudChcbiAgcmVxdWVzdDogS2liYW5hUmVxdWVzdCxcbiAgdXNlcm5hbWU6IHN0cmluZyxcbiAgYXZhaWxhYmVUZW5hbnRzOiBhbnksXG4gIGNvbmZpZzogU2VjdXJpdHlQbHVnaW5Db25maWdUeXBlLFxuICBjb29raWU6IFNlY3VyaXR5U2Vzc2lvbkNvb2tpZVxuKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgbGV0IHNlbGVjdGVkVGVuYW50OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIGNvbnN0IHF1ZXJ5OiBhbnkgPSByZXF1ZXN0LnVybC5xdWVyeSBhcyBhbnk7XG4gIGlmIChxdWVyeSAmJiAocXVlcnkuc2VjdXJpdHlfdGVuYW50IHx8IHF1ZXJ5LnNlY3VyaXR5dGVuYW50KSkge1xuICAgIHNlbGVjdGVkVGVuYW50ID0gcXVlcnkuc2VjdXJpdHlfdGVuYW50ID8gcXVlcnkuc2VjdXJpdHlfdGVuYW50IDogcXVlcnkuc2VjdXJpdHl0ZW5hbnQ7XG4gIH0gZWxzZSBpZiAocmVxdWVzdC5oZWFkZXJzLnNlY3VyaXR5dGVuYW50IHx8IHJlcXVlc3QuaGVhZGVycy5zZWN1cml0eV90ZW5hbnQpIHtcbiAgICBzZWxlY3RlZFRlbmFudCA9IHJlcXVlc3QuaGVhZGVycy5zZWN1cml0eXRlbmFudFxuICAgICAgPyAocmVxdWVzdC5oZWFkZXJzLnNlY3VyaXR5dGVuYW50IGFzIHN0cmluZylcbiAgICAgIDogKHJlcXVlc3QuaGVhZGVycy5zZWN1cml0eV90ZW5hbnQgYXMgc3RyaW5nKTtcbiAgfSBlbHNlIGlmIChpc1ZhbGlkVGVuYW50KGNvb2tpZS50ZW5hbnQpKSB7XG4gICAgc2VsZWN0ZWRUZW5hbnQgPSBjb29raWUudGVuYW50O1xuICB9IGVsc2Uge1xuICAgIHNlbGVjdGVkVGVuYW50ID0gdW5kZWZpbmVkO1xuICB9XG5cbiAgY29uc3QgcHJlZmVycmVkVGVuYW50cyA9IGNvbmZpZy5tdWx0aXRlbmFuY3k/LnRlbmFudHMucHJlZmVycmVkO1xuICBjb25zdCBnbG9iYWxUZW5hbnRFbmFibGVkID0gY29uZmlnLm11bHRpdGVuYW5jeT8udGVuYW50cy5lbmFibGVfZ2xvYmFsIHx8IGZhbHNlO1xuICBjb25zdCBwcml2YXRlVGVuYW50RW5hYmxlZCA9IGNvbmZpZy5tdWx0aXRlbmFuY3k/LnRlbmFudHMuZW5hYmxlX3ByaXZhdGUgfHwgZmFsc2U7XG5cbiAgcmV0dXJuIHJlc29sdmUoXG4gICAgdXNlcm5hbWUsXG4gICAgc2VsZWN0ZWRUZW5hbnQsXG4gICAgcHJlZmVycmVkVGVuYW50cyxcbiAgICBhdmFpbGFiZVRlbmFudHMsXG4gICAgZ2xvYmFsVGVuYW50RW5hYmxlZCxcbiAgICBwcml2YXRlVGVuYW50RW5hYmxlZFxuICApO1xufVxuXG4vKipcbiAqIERldGVybWluZXMgd2hldGhlciB0aGUgcmVxdWVzdCByZXF1aXJlcyB0ZW5hbnQgaW5mby5cbiAqIEBwYXJhbSByZXF1ZXN0IGtpYmFuYSByZXF1ZXN0LlxuICpcbiAqIEByZXR1cm5zIHRydWUgaWYgdGhlIHJlcXVlc3QgcmVxdWlyZXMgdGVuYW50IGluZm8sIG90aGVyd2lzZSBmYWxzZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGlzTXVsdGl0ZW5hbnRQYXRoKHJlcXVlc3Q6IEtpYmFuYVJlcXVlc3QpOiBib29sZWFuIHtcbiAgcmV0dXJuIChcbiAgICByZXF1ZXN0LnVybC5wYXRobmFtZT8uc3RhcnRzV2l0aCgnL2VsYXN0aWNzZWFyY2gnKSB8fFxuICAgIHJlcXVlc3QudXJsLnBhdGhuYW1lPy5zdGFydHNXaXRoKCcvYXBpJykgfHxcbiAgICByZXF1ZXN0LnVybC5wYXRobmFtZT8uc3RhcnRzV2l0aCgnL2FwcCcpIHx8XG4gICAgLy8gc2hvcnQgdXJsIHBhdGhcbiAgICByZXF1ZXN0LnVybC5wYXRobmFtZT8uc3RhcnRzV2l0aCgnL2dvdG8nKSB8fFxuICAgIC8vIGJvb3RzdHJhcC5qcyBkZXBlbmRzIG9uIHRlbmFudCBpbmZvIHRvIGZldGNoIGtpYmFuYSBjb25maWdzIGluIHRlbmFudCBpbmRleFxuICAgIChyZXF1ZXN0LnVybC5wYXRobmFtZT8uaW5kZXhPZignYm9vdHN0cmFwLmpzJykgfHwgLTEpID4gLTEgfHxcbiAgICByZXF1ZXN0LnVybC5wYXRobmFtZSA9PT0gJy8nXG4gICk7XG59XG5cbmZ1bmN0aW9uIHJlc29sdmUoXG4gIHVzZXJuYW1lOiBzdHJpbmcsXG4gIHJlcXVlc3RlZFRlbmFudDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICBwcmVmZXJyZWRUZW5hbnRzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCxcbiAgYXZhaWxhYmxlVGVuYW50czogYW55LCAvLyBpcyBhbiBvYmplY3QgbGlrZSB7IHRlbmFudF9uYW1lXzE6IHRydWUsIHRlbmFudF9uYW1lXzI6IGZhbHNlLCAuLi4gfVxuICBnbG9iYWxUZW5hbnRFbmFibGVkOiBib29sZWFuLFxuICBwcml2YXRlVGVuYW50RW5hYmxlZDogYm9vbGVhblxuKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgYXZhaWxhYmxlVGVuYW50c0Nsb25lID0gY2xvbmVEZWVwKGF2YWlsYWJsZVRlbmFudHMpO1xuICBkZWxldGUgYXZhaWxhYmxlVGVuYW50c0Nsb25lW3VzZXJuYW1lXTtcblxuICBpZiAoIWdsb2JhbFRlbmFudEVuYWJsZWQgJiYgIXByaXZhdGVUZW5hbnRFbmFibGVkICYmIGlzRW1wdHkoYXZhaWxhYmxlVGVuYW50c0Nsb25lKSkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBpZiAoaXNWYWxpZFRlbmFudChyZXF1ZXN0ZWRUZW5hbnQpKSB7XG4gICAgcmVxdWVzdGVkVGVuYW50ID0gcmVxdWVzdGVkVGVuYW50ITtcbiAgICBpZiAocmVxdWVzdGVkVGVuYW50IGluIGF2YWlsYWJsZVRlbmFudHMpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0ZWRUZW5hbnQ7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgcHJpdmF0ZVRlbmFudEVuYWJsZWQgJiZcbiAgICAgIHVzZXJuYW1lIGluIGF2YWlsYWJsZVRlbmFudHMgJiZcbiAgICAgIFBSSVZBVEVfVEVOQU5UUy5pbmRleE9mKHJlcXVlc3RlZFRlbmFudCkgPiAtMVxuICAgICkge1xuICAgICAgcmV0dXJuIFBSSVZBVEVfVEVOQU5UX1NZTUJPTDtcbiAgICB9XG5cbiAgICBpZiAoZ2xvYmFsVGVuYW50RW5hYmxlZCAmJiBHTE9CQUxfVEVOQU5UUy5pbmRleE9mKHJlcXVlc3RlZFRlbmFudCkgPiAtMSkge1xuICAgICAgcmV0dXJuIEdMT0JBTF9URU5BTlRfU1lNQk9MO1xuICAgIH1cbiAgfVxuXG4gIGlmIChwcmVmZXJyZWRUZW5hbnRzICYmICFpc0VtcHR5KHByZWZlcnJlZFRlbmFudHMpKSB7XG4gICAgZm9yIChjb25zdCBlbGVtZW50IG9mIHByZWZlcnJlZFRlbmFudHMpIHtcbiAgICAgIGNvbnN0IHRlbmFudCA9IGVsZW1lbnQudG9Mb3dlckNhc2UoKTtcblxuICAgICAgaWYgKGdsb2JhbFRlbmFudEVuYWJsZWQgJiYgR0xPQkFMX1RFTkFOVFMuaW5kZXhPZih0ZW5hbnQpID4gLTEpIHtcbiAgICAgICAgcmV0dXJuIEdMT0JBTF9URU5BTlRfU1lNQk9MO1xuICAgICAgfVxuXG4gICAgICBpZiAoXG4gICAgICAgIHByaXZhdGVUZW5hbnRFbmFibGVkICYmXG4gICAgICAgIFBSSVZBVEVfVEVOQU5UUy5pbmRleE9mKHRlbmFudCkgPiAtMSAmJlxuICAgICAgICB1c2VybmFtZSBpbiBhdmFpbGFibGVUZW5hbnRzXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIFBSSVZBVEVfVEVOQU5UX1NZTUJPTDtcbiAgICAgIH1cblxuICAgICAgaWYgKHRlbmFudCBpbiBhdmFpbGFibGVUZW5hbnRzKSB7XG4gICAgICAgIHJldHVybiB0ZW5hbnQ7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKGdsb2JhbFRlbmFudEVuYWJsZWQpIHtcbiAgICByZXR1cm4gR0xPQkFMX1RFTkFOVF9TWU1CT0w7XG4gIH1cblxuICBpZiAocHJpdmF0ZVRlbmFudEVuYWJsZWQpIHtcbiAgICByZXR1cm4gUFJJVkFURV9URU5BTlRfU1lNQk9MO1xuICB9XG5cbiAgLy8gZmFsbCBiYWNrIHRvIHRoZSBmaXJzdCB0ZW5hbnQgaW4gdGhlIGF2YWlsYWJsZSB0ZW5hbnRzXG4gIHJldHVybiBmaW5kS2V5KGF2YWlsYWJsZVRlbmFudHNDbG9uZSwgKCkgPT4gdHJ1ZSk7XG59XG5cbi8qKlxuICogUmV0dXJuIHRydWUgaWYgdGVuYW50IHBhcmFtZXRlciBpcyBhIHZhbGlkIHRlbmVudC5cbiAqXG4gKiBOb3RlOiBlbXB0eSBzdHJpbmcgJycgaXMgdmFsaWQsIHdoaWNoIG1lYW5zIGdsb2JhbCB0ZW5hbnQuXG4gKlxuICogQHBhcmFtIHRlbmFudFxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZFRlbmFudCh0ZW5hbnQ6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwpOiBib29sZWFuIHtcbiAgcmV0dXJuIHRlbmFudCAhPT0gdW5kZWZpbmVkICYmIHRlbmFudCAhPT0gbnVsbDtcbn1cbiJdfQ==