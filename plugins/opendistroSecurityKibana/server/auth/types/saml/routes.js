"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SamlAuthRoutes = void 0;

var _configSchema = require("@kbn/config-schema");

var _next_url = require("../../../utils/next_url");

/*
 *   Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *   Licensed under the Apache License, Version 2.0 (the "License").
 *   You may not use this file except in compliance with the License.
 *   A copy of the License is located at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *   or in the "license" file accompanying this file. This file is distributed
 *   on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 *   express or implied. See the License for the specific language governing
 *   permissions and limitations under the License.
 */
class SamlAuthRoutes {
  constructor(router, config, sessionStorageFactory, securityClient, coreSetup) {
    this.router = router;
    this.config = config;
    this.sessionStorageFactory = sessionStorageFactory;
    this.securityClient = securityClient;
    this.coreSetup = coreSetup;
  }

  setupRoutes() {
    this.router.get({
      path: `/auth/saml/login`,
      validate: {
        query: _configSchema.schema.object({
          nextUrl: _configSchema.schema.maybe(_configSchema.schema.string({
            validate: _next_url.validateNextUrl
          }))
        })
      },
      options: {
        authRequired: false
      }
    }, async (context, request, response) => {
      if (request.auth.isAuthenticated) {
        return response.redirected({
          headers: {
            location: `${this.coreSetup.http.basePath.serverBasePath}/app/kibana`
          }
        });
      }

      try {
        const samlHeader = await this.securityClient.getSamlHeader(request);
        const cookie = {
          saml: {
            nextUrl: request.query.nextUrl,
            requestId: samlHeader.requestId
          }
        };
        this.sessionStorageFactory.asScoped(request).set(cookie);
        return response.redirected({
          headers: {
            location: samlHeader.location
          }
        });
      } catch (error) {
        context.security_plugin.logger.error(`Failed to get saml header: ${error}`);
        return response.internalError(); // TODO: redirect to error page?
      }
    });
    this.router.post({
      path: `/_opendistro/_security/saml/acs`,
      validate: {
        body: _configSchema.schema.any()
      },
      options: {
        authRequired: false
      }
    }, async (context, request, response) => {
      let requestId = '';
      let nextUrl = '/';

      try {
        const cookie = await this.sessionStorageFactory.asScoped(request).get();

        if (cookie) {
          var _cookie$saml, _cookie$saml2;

          requestId = ((_cookie$saml = cookie.saml) === null || _cookie$saml === void 0 ? void 0 : _cookie$saml.requestId) || '';
          nextUrl = ((_cookie$saml2 = cookie.saml) === null || _cookie$saml2 === void 0 ? void 0 : _cookie$saml2.nextUrl) || `${this.coreSetup.http.basePath.serverBasePath}/app/kibana`;
        }

        if (!requestId) {
          return response.badRequest({
            body: 'Invalid requestId'
          });
        }
      } catch (error) {
        context.security_plugin.logger.error(`Failed to parse cookie: ${error}`);
        return response.badRequest();
      }

      try {
        const credentials = await this.securityClient.authToken(requestId, request.body.SAMLResponse, undefined);
        const user = await this.securityClient.authenticateWithHeader(request, 'authorization', credentials.authorization);
        const cookie = {
          username: user.username,
          credentials: {
            authHeaderValue: credentials.authorization
          },
          authType: 'saml',
          // TODO: create constant
          expiryTime: Date.now() + this.config.session.ttl
        };
        this.sessionStorageFactory.asScoped(request).set(cookie);
        return response.redirected({
          headers: {
            location: nextUrl
          }
        });
      } catch (error) {
        context.security_plugin.logger.error(`SAML SP initiated authentication workflow failed: ${error}`);
      }

      return response.internalError();
    });
    this.router.post({
      path: `/_opendistro/_security/saml/acs/idpinitiated`,
      validate: {
        body: _configSchema.schema.any()
      },
      options: {
        authRequired: false
      }
    }, async (context, request, response) => {
      const acsEndpoint = `${this.coreSetup.http.basePath.serverBasePath}/_opendistro/_security/saml/acs/idpinitiated`;

      try {
        const credentials = await this.securityClient.authToken(undefined, request.body.SAMLResponse, acsEndpoint);
        const user = await this.securityClient.authenticateWithHeader(request, 'authorization', credentials.authorization);
        const cookie = {
          username: user.username,
          credentials: {
            authHeaderValue: credentials.authorization
          },
          authType: 'saml',
          // TODO: create constant
          expiryTime: Date.now() + this.config.session.ttl
        };
        this.sessionStorageFactory.asScoped(request).set(cookie);
        return response.redirected({
          headers: {
            location: `${this.coreSetup.http.basePath.serverBasePath}/app/kibana`
          }
        });
      } catch (error) {
        context.security_plugin.logger.error(`SAML IDP initiated authentication workflow failed: ${error}`);
      }

      return response.internalError();
    });
    this.router.get({
      path: `/auth/logout`,
      validate: false
    }, async (context, request, response) => {
      try {
        const authInfo = await this.securityClient.authinfo(request);
        this.sessionStorageFactory.asScoped(request).clear(); // TODO: need a default logout page

        const redirectUrl = authInfo.sso_logout_url || this.coreSetup.http.basePath.serverBasePath || '/';
        return response.redirected({
          headers: {
            location: redirectUrl
          }
        });
      } catch (error) {
        context.security_plugin.logger.error(`SAML logout failed: ${error}`);
        return response.badRequest();
      }
    });
  }

}

exports.SamlAuthRoutes = SamlAuthRoutes;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJvdXRlcy50cyJdLCJuYW1lcyI6WyJTYW1sQXV0aFJvdXRlcyIsImNvbnN0cnVjdG9yIiwicm91dGVyIiwiY29uZmlnIiwic2Vzc2lvblN0b3JhZ2VGYWN0b3J5Iiwic2VjdXJpdHlDbGllbnQiLCJjb3JlU2V0dXAiLCJzZXR1cFJvdXRlcyIsImdldCIsInBhdGgiLCJ2YWxpZGF0ZSIsInF1ZXJ5Iiwic2NoZW1hIiwib2JqZWN0IiwibmV4dFVybCIsIm1heWJlIiwic3RyaW5nIiwidmFsaWRhdGVOZXh0VXJsIiwib3B0aW9ucyIsImF1dGhSZXF1aXJlZCIsImNvbnRleHQiLCJyZXF1ZXN0IiwicmVzcG9uc2UiLCJhdXRoIiwiaXNBdXRoZW50aWNhdGVkIiwicmVkaXJlY3RlZCIsImhlYWRlcnMiLCJsb2NhdGlvbiIsImh0dHAiLCJiYXNlUGF0aCIsInNlcnZlckJhc2VQYXRoIiwic2FtbEhlYWRlciIsImdldFNhbWxIZWFkZXIiLCJjb29raWUiLCJzYW1sIiwicmVxdWVzdElkIiwiYXNTY29wZWQiLCJzZXQiLCJlcnJvciIsInNlY3VyaXR5X3BsdWdpbiIsImxvZ2dlciIsImludGVybmFsRXJyb3IiLCJwb3N0IiwiYm9keSIsImFueSIsImJhZFJlcXVlc3QiLCJjcmVkZW50aWFscyIsImF1dGhUb2tlbiIsIlNBTUxSZXNwb25zZSIsInVuZGVmaW5lZCIsInVzZXIiLCJhdXRoZW50aWNhdGVXaXRoSGVhZGVyIiwiYXV0aG9yaXphdGlvbiIsInVzZXJuYW1lIiwiYXV0aEhlYWRlclZhbHVlIiwiYXV0aFR5cGUiLCJleHBpcnlUaW1lIiwiRGF0ZSIsIm5vdyIsInNlc3Npb24iLCJ0dGwiLCJhY3NFbmRwb2ludCIsImF1dGhJbmZvIiwiYXV0aGluZm8iLCJjbGVhciIsInJlZGlyZWN0VXJsIiwic3NvX2xvZ291dF91cmwiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFlQTs7QUFNQTs7QUFyQkE7Ozs7Ozs7Ozs7Ozs7O0FBdUJPLE1BQU1BLGNBQU4sQ0FBcUI7QUFD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LFFBQVEsR0FBRyxNQUFNLEtBQUt6RCxjQUFMLENBQW9CMEQsUUFBcEIsQ0FBNkIxQyxPQUE3QixDQUF2QjtBQUNBLGFBQUtqQixxQkFBTCxDQUEyQmdDLFFBQTNCLENBQW9DZixPQUFwQyxFQUE2QzJDLEtBQTdDLEdBRkUsQ0FHRjs7QUFDQSxjQUFNQyxXQUFXLEdBQ2ZILFFBQVEsQ0FBQ0ksY0FBVCxJQUEyQixLQUFLNUQsU0FBTCxDQUFlc0IsSUFBZixDQUFvQkMsUUFBcEIsQ0FBNkJDLGNBQXhELElBQTBFLEdBRDVFO0FBRUEsZUFBT1IsUUFBUSxDQUFDRyxVQUFULENBQW9CO0FBQ3pCQyxVQUFBQSxPQUFPLEVBQUU7QUFDUEMsWUFBQUEsUUFBUSxFQUFFc0M7QUFESDtBQURnQixTQUFwQixDQUFQO0FBS0QsT0FYRCxDQVdFLE9BQU8zQixLQUFQLEVBQWM7QUFDZGxCLFFBQUFBLE9BQU8sQ0FBQ21CLGVBQVIsQ0FBd0JDLE1BQXhCLENBQStCRixLQUEvQixDQUFzQyx1QkFBc0JBLEtBQU0sRUFBbEU7QUFDQSxlQUFPaEIsUUFBUSxDQUFDdUIsVUFBVCxFQUFQO0FBQ0Q7QUFDRixLQXJCSDtBQXVCRDs7QUEvTHlCIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqICAgQ29weXJpZ2h0IDIwMjAgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiAgIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqICAgQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgIG9yIGluIHRoZSBcImxpY2Vuc2VcIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZFxuICogICBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqICAgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqICAgcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IHNjaGVtYSB9IGZyb20gJ0BrYm4vY29uZmlnLXNjaGVtYSc7XG5pbXBvcnQgeyBJUm91dGVyLCBTZXNzaW9uU3RvcmFnZUZhY3RvcnksIEtpYmFuYVJlcXVlc3QgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi8uLi9zcmMvY29yZS9zZXJ2ZXInO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXNzaW9uQ29va2llIH0gZnJvbSAnLi4vLi4vLi4vc2Vzc2lvbi9zZWN1cml0eV9jb29raWUnO1xuaW1wb3J0IHsgU2VjdXJpdHlQbHVnaW5Db25maWdUeXBlIH0gZnJvbSAnLi4vLi4vLi4nO1xuaW1wb3J0IHsgU2VjdXJpdHlDbGllbnQgfSBmcm9tICcuLi8uLi8uLi9iYWNrZW5kL29wZW5kaXN0cm9fc2VjdXJpdHlfY2xpZW50JztcbmltcG9ydCB7IENvcmVTZXR1cCB9IGZyb20gJy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9jb3JlL3NlcnZlcic7XG5pbXBvcnQgeyB2YWxpZGF0ZU5leHRVcmwgfSBmcm9tICcuLi8uLi8uLi91dGlscy9uZXh0X3VybCc7XG5cbmV4cG9ydCBjbGFzcyBTYW1sQXV0aFJvdXRlcyB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcm91dGVyOiBJUm91dGVyLFxuICAgIC8vIEB0cy1pZ25vcmU6IHVudXNlZCB2YXJpYWJsZVxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnOiBTZWN1cml0eVBsdWdpbkNvbmZpZ1R5cGUsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZXNzaW9uU3RvcmFnZUZhY3Rvcnk6IFNlc3Npb25TdG9yYWdlRmFjdG9yeTxTZWN1cml0eVNlc3Npb25Db29raWU+LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgc2VjdXJpdHlDbGllbnQ6IFNlY3VyaXR5Q2xpZW50LFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29yZVNldHVwOiBDb3JlU2V0dXBcbiAgKSB7fVxuXG4gIHB1YmxpYyBzZXR1cFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlci5nZXQoXG4gICAgICB7XG4gICAgICAgIHBhdGg6IGAvYXV0aC9zYW1sL2xvZ2luYCxcbiAgICAgICAgdmFsaWRhdGU6IHtcbiAgICAgICAgICBxdWVyeTogc2NoZW1hLm9iamVjdCh7XG4gICAgICAgICAgICBuZXh0VXJsOiBzY2hlbWEubWF5YmUoXG4gICAgICAgICAgICAgIHNjaGVtYS5zdHJpbmcoe1xuICAgICAgICAgICAgICAgIHZhbGlkYXRlOiB2YWxpZGF0ZU5leHRVcmwsXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0pLFxuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgYXV0aFJlcXVpcmVkOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBhc3luYyAoY29udGV4dCwgcmVxdWVzdCwgcmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKHJlcXVlc3QuYXV0aC5pc0F1dGhlbnRpY2F0ZWQpIHtcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3RlZCh7XG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgIGxvY2F0aW9uOiBgJHt0aGlzLmNvcmVTZXR1cC5odHRwLmJhc2VQYXRoLnNlcnZlckJhc2VQYXRofS9hcHAva2liYW5hYCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHNhbWxIZWFkZXIgPSBhd2FpdCB0aGlzLnNlY3VyaXR5Q2xpZW50LmdldFNhbWxIZWFkZXIocmVxdWVzdCk7XG4gICAgICAgICAgY29uc3QgY29va2llOiBTZWN1cml0eVNlc3Npb25Db29raWUgPSB7XG4gICAgICAgICAgICBzYW1sOiB7XG4gICAgICAgICAgICAgIG5leHRVcmw6IHJlcXVlc3QucXVlcnkubmV4dFVybCxcbiAgICAgICAgICAgICAgcmVxdWVzdElkOiBzYW1sSGVhZGVyLnJlcXVlc3RJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfTtcbiAgICAgICAgICB0aGlzLnNlc3Npb25TdG9yYWdlRmFjdG9yeS5hc1Njb3BlZChyZXF1ZXN0KS5zZXQoY29va2llKTtcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3RlZCh7XG4gICAgICAgICAgICBoZWFkZXJzOiB7XG4gICAgICAgICAgICAgIGxvY2F0aW9uOiBzYW1sSGVhZGVyLmxvY2F0aW9uLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb250ZXh0LnNlY3VyaXR5X3BsdWdpbi5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBnZXQgc2FtbCBoZWFkZXI6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmludGVybmFsRXJyb3IoKTsgLy8gVE9ETzogcmVkaXJlY3QgdG8gZXJyb3IgcGFnZT9cbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLnJvdXRlci5wb3N0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBgL19vcGVuZGlzdHJvL19zZWN1cml0eS9zYW1sL2Fjc2AsXG4gICAgICAgIHZhbGlkYXRlOiB7XG4gICAgICAgICAgYm9keTogc2NoZW1hLmFueSgpLFxuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zOiB7XG4gICAgICAgICAgYXV0aFJlcXVpcmVkOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICBhc3luYyAoY29udGV4dCwgcmVxdWVzdCwgcmVzcG9uc2UpID0+IHtcbiAgICAgICAgbGV0IHJlcXVlc3RJZDogc3RyaW5nID0gJyc7XG4gICAgICAgIGxldCBuZXh0VXJsOiBzdHJpbmcgPSAnLyc7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgY29va2llID0gYXdhaXQgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuZ2V0KCk7XG4gICAgICAgICAgaWYgKGNvb2tpZSkge1xuICAgICAgICAgICAgcmVxdWVzdElkID0gY29va2llLnNhbWw/LnJlcXVlc3RJZCB8fCAnJztcbiAgICAgICAgICAgIG5leHRVcmwgPVxuICAgICAgICAgICAgICBjb29raWUuc2FtbD8ubmV4dFVybCB8fCBgJHt0aGlzLmNvcmVTZXR1cC5odHRwLmJhc2VQYXRoLnNlcnZlckJhc2VQYXRofS9hcHAva2liYW5hYDtcbiAgICAgICAgICB9XG4gICAgICAgICAgaWYgKCFyZXF1ZXN0SWQpIHtcbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KHtcbiAgICAgICAgICAgICAgYm9keTogJ0ludmFsaWQgcmVxdWVzdElkJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb250ZXh0LnNlY3VyaXR5X3BsdWdpbi5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byBwYXJzZSBjb29raWU6ICR7ZXJyb3J9YCk7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3QoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgY3JlZGVudGlhbHMgPSBhd2FpdCB0aGlzLnNlY3VyaXR5Q2xpZW50LmF1dGhUb2tlbihcbiAgICAgICAgICAgIHJlcXVlc3RJZCxcbiAgICAgICAgICAgIHJlcXVlc3QuYm9keS5TQU1MUmVzcG9uc2UsXG4gICAgICAgICAgICB1bmRlZmluZWRcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCB0aGlzLnNlY3VyaXR5Q2xpZW50LmF1dGhlbnRpY2F0ZVdpdGhIZWFkZXIoXG4gICAgICAgICAgICByZXF1ZXN0LFxuICAgICAgICAgICAgJ2F1dGhvcml6YXRpb24nLFxuICAgICAgICAgICAgY3JlZGVudGlhbHMuYXV0aG9yaXphdGlvblxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgY29va2llOiBTZWN1cml0eVNlc3Npb25Db29raWUgPSB7XG4gICAgICAgICAgICB1c2VybmFtZTogdXNlci51c2VybmFtZSxcbiAgICAgICAgICAgIGNyZWRlbnRpYWxzOiB7XG4gICAgICAgICAgICAgIGF1dGhIZWFkZXJWYWx1ZTogY3JlZGVudGlhbHMuYXV0aG9yaXphdGlvbixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhdXRoVHlwZTogJ3NhbWwnLCAvLyBUT0RPOiBjcmVhdGUgY29uc3RhbnRcbiAgICAgICAgICAgIGV4cGlyeVRpbWU6IERhdGUubm93KCkgKyB0aGlzLmNvbmZpZy5zZXNzaW9uLnR0bCxcbiAgICAgICAgICB9O1xuICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2VGYWN0b3J5LmFzU2NvcGVkKHJlcXVlc3QpLnNldChjb29raWUpO1xuICAgICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdGVkKHtcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgbG9jYXRpb246IG5leHRVcmwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnRleHQuc2VjdXJpdHlfcGx1Z2luLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgIGBTQU1MIFNQIGluaXRpYXRlZCBhdXRoZW50aWNhdGlvbiB3b3JrZmxvdyBmYWlsZWQ6ICR7ZXJyb3J9YFxuICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmVzcG9uc2UuaW50ZXJuYWxFcnJvcigpO1xuICAgICAgfVxuICAgICk7XG5cbiAgICB0aGlzLnJvdXRlci5wb3N0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBgL19vcGVuZGlzdHJvL19zZWN1cml0eS9zYW1sL2Fjcy9pZHBpbml0aWF0ZWRgLFxuICAgICAgICB2YWxpZGF0ZToge1xuICAgICAgICAgIGJvZHk6IHNjaGVtYS5hbnkoKSxcbiAgICAgICAgfSxcbiAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgIGF1dGhSZXF1aXJlZDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgYXN5bmMgKGNvbnRleHQsIHJlcXVlc3QsIHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGNvbnN0IGFjc0VuZHBvaW50ID0gYCR7dGhpcy5jb3JlU2V0dXAuaHR0cC5iYXNlUGF0aC5zZXJ2ZXJCYXNlUGF0aH0vX29wZW5kaXN0cm8vX3NlY3VyaXR5L3NhbWwvYWNzL2lkcGluaXRpYXRlZGA7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgY3JlZGVudGlhbHMgPSBhd2FpdCB0aGlzLnNlY3VyaXR5Q2xpZW50LmF1dGhUb2tlbihcbiAgICAgICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgICAgIHJlcXVlc3QuYm9keS5TQU1MUmVzcG9uc2UsXG4gICAgICAgICAgICBhY3NFbmRwb2ludFxuICAgICAgICAgICk7XG4gICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IHRoaXMuc2VjdXJpdHlDbGllbnQuYXV0aGVudGljYXRlV2l0aEhlYWRlcihcbiAgICAgICAgICAgIHJlcXVlc3QsXG4gICAgICAgICAgICAnYXV0aG9yaXphdGlvbicsXG4gICAgICAgICAgICBjcmVkZW50aWFscy5hdXRob3JpemF0aW9uXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb25zdCBjb29raWU6IFNlY3VyaXR5U2Vzc2lvbkNvb2tpZSA9IHtcbiAgICAgICAgICAgIHVzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLFxuICAgICAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICAgICAgYXV0aEhlYWRlclZhbHVlOiBjcmVkZW50aWFscy5hdXRob3JpemF0aW9uLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGF1dGhUeXBlOiAnc2FtbCcsIC8vIFRPRE86IGNyZWF0ZSBjb25zdGFudFxuICAgICAgICAgICAgZXhwaXJ5VGltZTogRGF0ZS5ub3coKSArIHRoaXMuY29uZmlnLnNlc3Npb24udHRsLFxuICAgICAgICAgIH07XG4gICAgICAgICAgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuc2V0KGNvb2tpZSk7XG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0ZWQoe1xuICAgICAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICAgICBsb2NhdGlvbjogYCR7dGhpcy5jb3JlU2V0dXAuaHR0cC5iYXNlUGF0aC5zZXJ2ZXJCYXNlUGF0aH0vYXBwL2tpYmFuYWAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIGNvbnRleHQuc2VjdXJpdHlfcGx1Z2luLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICAgIGBTQU1MIElEUCBpbml0aWF0ZWQgYXV0aGVudGljYXRpb24gd29ya2Zsb3cgZmFpbGVkOiAke2Vycm9yfWBcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXNwb25zZS5pbnRlcm5hbEVycm9yKCk7XG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMucm91dGVyLmdldChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogYC9hdXRoL2xvZ291dGAsXG4gICAgICAgIHZhbGlkYXRlOiBmYWxzZSxcbiAgICAgIH0sXG4gICAgICBhc3luYyAoY29udGV4dCwgcmVxdWVzdCwgcmVzcG9uc2UpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCBhdXRoSW5mbyA9IGF3YWl0IHRoaXMuc2VjdXJpdHlDbGllbnQuYXV0aGluZm8ocmVxdWVzdCk7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuY2xlYXIoKTtcbiAgICAgICAgICAvLyBUT0RPOiBuZWVkIGEgZGVmYXVsdCBsb2dvdXQgcGFnZVxuICAgICAgICAgIGNvbnN0IHJlZGlyZWN0VXJsID1cbiAgICAgICAgICAgIGF1dGhJbmZvLnNzb19sb2dvdXRfdXJsIHx8IHRoaXMuY29yZVNldHVwLmh0dHAuYmFzZVBhdGguc2VydmVyQmFzZVBhdGggfHwgJy8nO1xuICAgICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdGVkKHtcbiAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgbG9jYXRpb246IHJlZGlyZWN0VXJsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBjb250ZXh0LnNlY3VyaXR5X3BsdWdpbi5sb2dnZXIuZXJyb3IoYFNBTUwgbG9nb3V0IGZhaWxlZDogJHtlcnJvcn1gKTtcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdCgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcbiAgfVxufVxuIl19