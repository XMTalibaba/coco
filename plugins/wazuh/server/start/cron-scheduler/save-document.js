"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SaveDocument = void 0;

var _getConfiguration = require("../../lib/get-configuration");

var _logger = require("../../lib/logger");

var _indexDate = require("../../lib/index-date");

var _constants = require("../../../common/constants");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class SaveDocument {
  constructor(context) {
    _defineProperty(this, "context", void 0);

    _defineProperty(this, "esClientInternalUser", void 0);

    _defineProperty(this, "logPath", 'cron-scheduler|SaveDocument');

    this.context = context;
    this.esClientInternalUser = context.core.elasticsearch.client.asInternalUser;
  }

  async save(doc, indexConfig) {
    const {
      name,
      creation,
      mapping,
      shards,
      replicas
    } = indexConfig;
    const index = this.addIndexPrefix(name);
    const indexCreation = `${index}-${(0, _indexDate.indexDate)(creation)}`;

    try {
      await this.checkIndexAndCreateIfNotExists(indexCreation, shards, replicas);
      const createDocumentObject = this.createDocument(doc, indexCreation, mapping);
      const response = await this.esClientInternalUser.bulk(createDocumentObject);
      (0, _logger.log)(this.logPath, `Response of create new document ${JSON.stringify(response)}`, 'debug'); // await this.checkIndexPatternAndCreateIfNotExists(index);
    } catch (error) {
      if (error.status === 403) throw {
        error: 403,
        message: `Authorization Exception in the index "${index}"`
      };
      if (error.status === 409) throw {
        error: 409,
        message: `Duplicate index-pattern: ${index}`
      };
      throw error;
    }
  }

  async checkIndexAndCreateIfNotExists(index, shards, replicas) {
    try {
      try {
        const exists = await this.esClientInternalUser.indices.exists({
          index
        });
        (0, _logger.log)(this.logPath, `Index '${index}' exists? ${exists.body}`, 'debug');

        if (!exists.body) {
          const response = await this.esClientInternalUser.indices.create({
            index,
            body: {
              settings: {
                index: {
                  number_of_shards: shards || _constants.WAZUH_INDEX_SHARDS,
                  number_of_replicas: replicas || _constants.WAZUH_INDEX_REPLICAS
                }
              }
            }
          });
          (0, _logger.log)(this.logPath, `Status of create a new index: ${JSON.stringify(response)}`, 'debug');
        }
      } catch (error) {
        (0, _logger.log)(this.logPath, `Error searching or creating '${index}' due to '${error.message || error}'`);
      }
    } catch (error) {
      this.checkDuplicateIndexError(error);
    }
  }

  checkDuplicateIndexError(error) {
    const {
      type
    } = ((error || {}).body || {}).error || {};
    if (!['resource_already_exists_exception'].includes(type)) throw error;
  }

  createDocument(doc, index, mapping) {
    const createDocumentObject = {
      index,
      type: '_doc',
      body: doc.flatMap(item => [{
        index: {
          _index: index
        }
      }, { ...this.buildData(item, mapping),
        timestamp: new Date(Date.now()).toISOString()
      }])
    };
    (0, _logger.log)(this.logPath, `Document object: ${JSON.stringify(createDocumentObject)}`, 'debug');
    return createDocumentObject;
  }

  buildData(item, mapping) {
    const getValue = (key, item) => {
      const keys = key.split('.');

      if (keys.length === 1) {
        return JSON.stringify(item[key]);
      }

      return getValue(keys.slice(1).join('.'), item[keys[0]]);
    };

    if (mapping) {
      const data = mapping.replace(/\${([a-z|A-Z|0-9|\.\-\_]+)}/gi, (...key) => getValue(key[1], item));
      return JSON.parse(data);
    }

    if (typeof item.data === 'object') {
      return item.data;
    }

    return {
      data: item.data
    };
  }

  addIndexPrefix(index) {
    const configFile = (0, _getConfiguration.getConfiguration)();
    const prefix = configFile['cron.prefix'] || 'wazuh';
    return `${prefix}-${index}`;
  }

}

exports.SaveDocument = SaveDocument;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNhdmUtZG9jdW1lbnQudHMiXSwibmFtZXMiOlsiU2F2ZURvY3VtZW50IiwiY29uc3RydWN0b3IiLCJjb250ZXh0IiwiZXNDbGllbnRJbnRlcm5hbFVzZXIiLCJjb3JlIiwiZWxhc3RpY3NlYXJjaCIsImNsaWVudCIsImFzSW50ZXJuYWxVc2VyIiwic2F2ZSIsImRvYyIsImluZGV4Q29uZmlnIiwibmFtZSIsImNyZWF0aW9uIiwibWFwcGluZyIsInNoYXJkcyIsInJlcGxpY2FzIiwiaW5kZXgiLCJhZGRJbmRleFByZWZpeCIsImluZGV4Q3JlYXRpb24iLCJjaGVja0luZGV4QW5kQ3JlYXRlSWZOb3RFeGlzdHMiLCJjcmVhdGVEb2N1bWVudE9iamVjdCIsImNyZWF0ZURvY3VtZW50IiwicmVzcG9uc2UiLCJidWxrIiwibG9nUGF0aCIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJleGlzdHMiLCJpbmRpY2VzIiwiYm9keSIsImNyZWF0ZSIsInNldHRpbmdzIiwibnVtYmVyX29mX3NoYXJkcyIsIldBWlVIX0lOREVYX1NIQVJEUyIsIm51bWJlcl9vZl9yZXBsaWNhcyIsIldBWlVIX0lOREVYX1JFUExJQ0FTIiwiY2hlY2tEdXBsaWNhdGVJbmRleEVycm9yIiwidHlwZSIsImluY2x1ZGVzIiwiZmxhdE1hcCIsIml0ZW0iLCJfaW5kZXgiLCJidWlsZERhdGEiLCJ0aW1lc3RhbXAiLCJEYXRlIiwibm93IiwidG9JU09TdHJpbmciLCJnZXRWYWx1ZSIsImtleSIsImtleXMiLCJzcGxpdCIsImxlbmd0aCIsInNsaWNlIiwiam9pbiIsImRhdGEiLCJyZXBsYWNlIiwicGFyc2UiLCJjb25maWdGaWxlIiwicHJlZml4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFVTyxNQUFNQSxZQUFOLENBQW1CO0FBS3hCQyxFQUFBQSxXQUFXLENBQUNDLE9BQUQsRUFBVTtBQUFBOztBQUFBOztBQUFB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bXBvcnQgeyBCdWxrSW5kZXhEb2N1bWVudHNQYXJhbXMgfSBmcm9tICdlbGFzdGljc2VhcmNoJztcbmltcG9ydCB7IGdldENvbmZpZ3VyYXRpb24gfSBmcm9tICcuLi8uLi9saWIvZ2V0LWNvbmZpZ3VyYXRpb24nO1xuaW1wb3J0IHsgbG9nIH0gZnJvbSAnLi4vLi4vbGliL2xvZ2dlcic7XG5pbXBvcnQgeyBpbmRleERhdGUgfSBmcm9tICcuLi8uLi9saWIvaW5kZXgtZGF0ZSc7XG5pbXBvcnQgeyBXQVpVSF9JTkRFWF9TSEFSRFMsIFdBWlVIX0lOREVYX1JFUExJQ0FTIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL2NvbnN0YW50cydcblxuZXhwb3J0IGludGVyZmFjZSBJSW5kZXhDb25maWd1cmF0aW9uIHtcbiAgbmFtZTogc3RyaW5nXG4gIGNyZWF0aW9uOiAnaCcgfCAnZCcgfCAndycgfCAnbSdcbiAgbWFwcGluZz86IHN0cmluZ1xuICBzaGFyZHM/OiBudW1iZXJcbiAgcmVwbGljYXM/OiBudW1iZXJcbn1cblxuZXhwb3J0IGNsYXNzIFNhdmVEb2N1bWVudCB7XG4gIGNvbnRleHQ6IGFueTtcbiAgZXNDbGllbnRJbnRlcm5hbFVzZXI6IGFueTtcbiAgbG9nUGF0aCA9ICdjcm9uLXNjaGVkdWxlcnxTYXZlRG9jdW1lbnQnO1xuXG4gIGNvbnN0cnVjdG9yKGNvbnRleHQpIHtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0O1xuICAgIHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIgPSBjb250ZXh0LmNvcmUuZWxhc3RpY3NlYXJjaC5jbGllbnQuYXNJbnRlcm5hbFVzZXI7XG4gIH1cblxuICBhc3luYyBzYXZlKGRvYzogb2JqZWN0W10sIGluZGV4Q29uZmlnOiBJSW5kZXhDb25maWd1cmF0aW9uKSB7XG4gICAgY29uc3QgeyBuYW1lLCBjcmVhdGlvbiwgbWFwcGluZywgc2hhcmRzLCByZXBsaWNhcyB9ID0gaW5kZXhDb25maWc7XG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmFkZEluZGV4UHJlZml4KG5hbWUpO1xuICAgIGNvbnN0IGluZGV4Q3JlYXRpb24gPSBgJHtpbmRleH0tJHtpbmRleERhdGUoY3JlYXRpb24pfWA7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuY2hlY2tJbmRleEFuZENyZWF0ZUlmTm90RXhpc3RzKGluZGV4Q3JlYXRpb24sIHNoYXJkcywgcmVwbGljYXMpO1xuICAgICAgY29uc3QgY3JlYXRlRG9jdW1lbnRPYmplY3QgPSB0aGlzLmNyZWF0ZURvY3VtZW50KGRvYywgaW5kZXhDcmVhdGlvbiwgbWFwcGluZyk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIuYnVsayhjcmVhdGVEb2N1bWVudE9iamVjdCk7XG4gICAgICBsb2codGhpcy5sb2dQYXRoLCBgUmVzcG9uc2Ugb2YgY3JlYXRlIG5ldyBkb2N1bWVudCAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gLCAnZGVidWcnKTtcbiAgICAgIC8vIGF3YWl0IHRoaXMuY2hlY2tJbmRleFBhdHRlcm5BbmRDcmVhdGVJZk5vdEV4aXN0cyhpbmRleCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChlcnJvci5zdGF0dXMgPT09IDQwMylcbiAgICAgICAgdGhyb3cgeyBlcnJvcjogNDAzLCBtZXNzYWdlOiBgQXV0aG9yaXphdGlvbiBFeGNlcHRpb24gaW4gdGhlIGluZGV4IFwiJHtpbmRleH1cImAgfVxuICAgICAgaWYgKGVycm9yLnN0YXR1cyA9PT0gNDA5KVxuICAgICAgICB0aHJvdyB7IGVycm9yOiA0MDksIG1lc3NhZ2U6IGBEdXBsaWNhdGUgaW5kZXgtcGF0dGVybjogJHtpbmRleH1gIH1cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY2hlY2tJbmRleEFuZENyZWF0ZUlmTm90RXhpc3RzKGluZGV4LCBzaGFyZHMsIHJlcGxpY2FzKSB7XG4gICAgdHJ5IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuZXNDbGllbnRJbnRlcm5hbFVzZXIuaW5kaWNlcy5leGlzdHMoeyBpbmRleCB9KTtcbiAgICAgICAgbG9nKHRoaXMubG9nUGF0aCwgYEluZGV4ICcke2luZGV4fScgZXhpc3RzPyAke2V4aXN0cy5ib2R5fWAsICdkZWJ1ZycpO1xuICAgICAgICBpZiAoIWV4aXN0cy5ib2R5KSB7XG4gICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmVzQ2xpZW50SW50ZXJuYWxVc2VyLmluZGljZXMuY3JlYXRlKHtcbiAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgYm9keToge1xuICAgICAgICAgICAgICBzZXR0aW5nczoge1xuICAgICAgICAgICAgICAgIGluZGV4OiB7XG4gICAgICAgICAgICAgICAgICBudW1iZXJfb2Zfc2hhcmRzOiBzaGFyZHMgfHwgV0FaVUhfSU5ERVhfU0hBUkRTLFxuICAgICAgICAgICAgICAgICAgbnVtYmVyX29mX3JlcGxpY2FzOiByZXBsaWNhcyB8fCBXQVpVSF9JTkRFWF9SRVBMSUNBU1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIGxvZyh0aGlzLmxvZ1BhdGgsIGBTdGF0dXMgb2YgY3JlYXRlIGEgbmV3IGluZGV4OiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlKX1gLCAnZGVidWcnKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbG9nKHRoaXMubG9nUGF0aCAsYEVycm9yIHNlYXJjaGluZyBvciBjcmVhdGluZyAnJHtpbmRleH0nIGR1ZSB0byAnJHtlcnJvci5tZXNzYWdlIHx8IGVycm9yfSdgKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5jaGVja0R1cGxpY2F0ZUluZGV4RXJyb3IoZXJyb3IpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tEdXBsaWNhdGVJbmRleEVycm9yKGVycm9yOiBhbnkpIHtcbiAgICBjb25zdCB7IHR5cGUgfSA9ICgoZXJyb3IgfHwge30pLmJvZHkgfHwge30pLmVycm9yIHx8IHt9O1xuICAgIGlmICghWydyZXNvdXJjZV9hbHJlYWR5X2V4aXN0c19leGNlcHRpb24nXS5pbmNsdWRlcyh0eXBlKSlcbiAgICAgIHRocm93IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVEb2N1bWVudChkb2MsIGluZGV4LCBtYXBwaW5nOiBzdHJpbmcpOiBCdWxrSW5kZXhEb2N1bWVudHNQYXJhbXMge1xuICAgIGNvbnN0IGNyZWF0ZURvY3VtZW50T2JqZWN0OiBCdWxrSW5kZXhEb2N1bWVudHNQYXJhbXMgPSB7XG4gICAgICBpbmRleCxcbiAgICAgIHR5cGU6ICdfZG9jJyxcbiAgICAgIGJvZHk6IGRvYy5mbGF0TWFwKGl0ZW0gPT4gW3tcbiAgICAgICAgaW5kZXg6IHsgX2luZGV4OiBpbmRleCB9XG4gICAgICB9LFxuICAgICAge1xuICAgICAgICAuLi50aGlzLmJ1aWxkRGF0YShpdGVtLCBtYXBwaW5nKSxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZShEYXRlLm5vdygpKS50b0lTT1N0cmluZygpXG4gICAgICB9XG4gICAgICBdKVxuICAgIH07XG4gICAgbG9nKHRoaXMubG9nUGF0aCwgYERvY3VtZW50IG9iamVjdDogJHtKU09OLnN0cmluZ2lmeShjcmVhdGVEb2N1bWVudE9iamVjdCl9YCwgJ2RlYnVnJyk7XG4gICAgcmV0dXJuIGNyZWF0ZURvY3VtZW50T2JqZWN0O1xuICB9XG5cbiAgYnVpbGREYXRhKGl0ZW0sIG1hcHBpbmcpIHtcbiAgICBjb25zdCBnZXRWYWx1ZSA9IChrZXk6IHN0cmluZywgaXRlbSkgPT4ge1xuICAgICAgY29uc3Qga2V5cyA9IGtleS5zcGxpdCgnLicpO1xuICAgICAgaWYgKGtleXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeShpdGVtW2tleV0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGdldFZhbHVlKGtleXMuc2xpY2UoMSkuam9pbignLicpLCBpdGVtW2tleXNbMF1dKVxuICAgIH1cbiAgICBpZiAobWFwcGluZykge1xuICAgICAgY29uc3QgZGF0YSA9IG1hcHBpbmcucmVwbGFjZShcbiAgICAgICAgL1xcJHsoW2EtenxBLVp8MC05fFxcLlxcLVxcX10rKX0vZ2ksXG4gICAgICAgICguLi5rZXkpID0+IGdldFZhbHVlKGtleVsxXSwgaXRlbSlcbiAgICAgIClcbiAgICAgIHJldHVybiBKU09OLnBhcnNlKGRhdGEpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGl0ZW0uZGF0YSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiBpdGVtLmRhdGE7XG4gICAgfVxuICAgIHJldHVybiB7IGRhdGE6IGl0ZW0uZGF0YSB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRJbmRleFByZWZpeChpbmRleCk6IHN0cmluZyB7XG4gICAgY29uc3QgY29uZmlnRmlsZSA9IGdldENvbmZpZ3VyYXRpb24oKTtcbiAgICBjb25zdCBwcmVmaXggPSBjb25maWdGaWxlWydjcm9uLnByZWZpeCddIHx8ICd3YXp1aCc7XG4gICAgcmV0dXJuIGAke3ByZWZpeH0tJHtpbmRleH1gO1xuICB9XG5cbn0iXX0=