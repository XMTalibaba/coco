"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.AuthenticationType = void 0;

var _opendistro_security_client = require("../../backend/opendistro_security_client");

var _tenant_resolver = require("../../multitenancy/tenant_resolver");

var _errors = require("../../errors");

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

class AuthenticationType {
  constructor(config, sessionStorageFactory, router, esClient, coreSetup, logger) {
    this.config = config;
    this.sessionStorageFactory = sessionStorageFactory;
    this.router = router;
    this.esClient = esClient;
    this.coreSetup = coreSetup;
    this.logger = logger;

    _defineProperty(this, "type", void 0);

    _defineProperty(this, "securityClient", void 0);

    _defineProperty(this, "authHandler", async (request, response, toolkit) => {
      var _this$config$multiten;

      // skip auth for APIs that do not require auth
      if (this.authNotRequired(request)) {
        return toolkit.authenticated();
      } // if browser request, auth logic is:
      //   1. check if request includes auth header or paramter(e.g. jwt in url params) is present, if so, authenticate with auth header.
      //   2. if auth header not present, check if auth cookie is present, if no cookie, send to authentication workflow
      //   3. verify whether auth cookie is valid, if not valid, send to authentication workflow
      //   4. if cookie is valid, pass to route handlers


      const authHeaders = {};
      let cookie;
      let authInfo; // if this is an REST API call, suppose the request includes necessary auth header
      // see https://www.elastic.co/guide/en/kibana/master/using-api.html

      if (this.requestIncludesAuthInfo(request)) {
        try {
          const additonalAuthHeader = this.getAdditionalAuthHeader(request);
          Object.assign(authHeaders, additonalAuthHeader);
          authInfo = await this.securityClient.authinfo(request, additonalAuthHeader);
          cookie = await this.getCookie(request, authInfo); // set tenant from cookie if exist

          const browserCookie = await this.sessionStorageFactory.asScoped(request).get();

          if (browserCookie && (0, _tenant_resolver.isValidTenant)(browserCookie.tenant)) {
            cookie.tenant = browserCookie.tenant;
          }

          this.sessionStorageFactory.asScoped(request).set(cookie);
        } catch (error) {
          return response.unauthorized({
            body: error.message
          });
        }
      } else {
        // no auth header in request, try cookie
        try {
          cookie = await this.sessionStorageFactory.asScoped(request).get();
        } catch (error) {
          this.logger.error(`Error parsing cookie: ${error.message}`);
          cookie = undefined;
        }

        if (!cookie || !(await this.isValidCookie(cookie))) {
          // clear cookie
          this.sessionStorageFactory.asScoped(request).clear(); // for assets, we can still pass it to resource handler as notHandled.
          // marking it as authenticated may result in login pop up when auth challenge
          // is enabled.

          if (request.url.pathname && request.url.pathname.startsWith('/bundles/')) {
            return toolkit.notHandled();
          } // send to auth workflow


          return this.handleUnauthedRequest(request, response, toolkit);
        } // extend session expiration time


        if (this.config.session.keepalive) {
          cookie.expiryTime = Date.now() + this.config.session.ttl;
          this.sessionStorageFactory.asScoped(request).set(cookie);
        } // cookie is valid
        // build auth header


        const authHeadersFromCookie = this.buildAuthHeaderFromCookie(cookie);
        Object.assign(authHeaders, authHeadersFromCookie);
        const additonalAuthHeader = this.getAdditionalAuthHeader(request);
        Object.assign(authHeaders, additonalAuthHeader);
      } // resolve tenant if necessary


      if (((_this$config$multiten = this.config.multitenancy) === null || _this$config$multiten === void 0 ? void 0 : _this$config$multiten.enabled) && (0, _tenant_resolver.isMultitenantPath)(request)) {
        try {
          const tenant = await this.resolveTenant(request, cookie, authHeaders, authInfo); // return 401 if no tenant available

          if (!(0, _tenant_resolver.isValidTenant)(tenant)) {
            return response.badRequest({
              body: 'No available tenant for current user, please reach out to your system administrator'
            });
          } // set tenant in header


          Object.assign(authHeaders, {
            securitytenant: tenant
          }); // set tenant to cookie

          if (tenant !== cookie.tenant) {
            cookie.tenant = tenant;
            this.sessionStorageFactory.asScoped(request).set(cookie);
          }
        } catch (error) {
          this.logger.error(`Failed to resolve user tenant: ${error}`);

          if (error instanceof _errors.UnauthenticatedError) {
            if (request.url.pathname && request.url.pathname.startsWith('/bundles/')) {
              return toolkit.notHandled();
            }

            this.sessionStorageFactory.asScoped(request).clear();
            return this.handleUnauthedRequest(request, response, toolkit);
          }

          throw error;
        }
      }

      return toolkit.authenticated({
        requestHeaders: authHeaders
      });
    });

    this.securityClient = new _opendistro_security_client.SecurityClient(esClient);
    this.type = '';
  }

  authNotRequired(request) {
    const pathname = request.url.pathname;

    if (!pathname) {
      return false;
    } // allow requests to ignored routes


    if (AuthenticationType.ROUTES_TO_IGNORE.includes(pathname)) {
      return true;
    } // allow requests to routes that doesn't require authentication


    if (this.config.auth.unauthenticated_routes.indexOf(pathname) > -1) {
      // TODO: use kibana server user
      return true;
    }

    return false;
  }

  async resolveTenant(request, cookie, authHeader, authInfo) {
    if (!authInfo) {
      try {
        authInfo = await this.securityClient.authinfo(request, authHeader);
      } catch (error) {
        throw new _errors.UnauthenticatedError(error);
      }
    }

    const selectedTenant = (0, _tenant_resolver.resolveTenant)(request, authInfo.user_name, authInfo.tenants, this.config, cookie);
    return selectedTenant;
  }

  isPageRequest(request) {
    const path = request.url.pathname || '/';
    return path.startsWith('/app/') || path === '/' || path.startsWith('/goto/');
  } // abstract functions for concrete auth types to implement


}

exports.AuthenticationType = AuthenticationType;

_defineProperty(AuthenticationType, "ROUTES_TO_IGNORE", ['/api/core/capabilities', // FIXME: need to figureout how to bypass this API call
'/app/login']);

_defineProperty(AuthenticationType, "REST_API_CALL_HEADER", 'kbn-xsrf');
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImF1dGhlbnRpY2F0aW9uX3R5cGUudHMiXSwibmFtZXMiOlsiQXV0aGVudGljYXRpb25UeXBlIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJzZXNzaW9uU3RvcmFnZUZhY3RvcnkiLCJyb3V0ZXIiLCJlc0NsaWVudCIsImNvcmVTZXR1cCIsImxvZ2dlciIsInJlcXVlc3QiLCJyZXNwb25zZSIsInRvb2xraXQiLCJhdXRoTm90UmVxdWlyZWQiLCJhdXRoZW50aWNhdGVkIiwiYXV0aEhlYWRlcnMiLCJjb29raWUiLCJhdXRoSW5mbyIsInJlcXVlc3RJbmNsdWRlc0F1dGhJbmZvIiwiYWRkaXRvbmFsQXV0aEhlYWRlciIsImdldEFkZGl0aW9uYWxBdXRoSGVhZGVyIiwiT2JqZWN0IiwiYXNzaWduIiwic2VjdXJpdHlDbGllbnQiLCJhdXRoaW5mbyIsImdldENvb2tpZSIsImJyb3dzZXJDb29raWUiLCJhc1Njb3BlZCIsImdldCIsInRlbmFudCIsInNldCIsImVycm9yIiwidW5hdXRob3JpemVkIiwiYm9keSIsIm1lc3NhZ2UiLCJ1bmRlZmluZWQiLCJpc1ZhbGlkQ29va2llIiwiY2xlYXIiLCJ1cmwiLCJwYXRobmFtZSIsInN0YXJ0c1dpdGgiLCJub3RIYW5kbGVkIiwiaGFuZGxlVW5hdXRoZWRSZXF1ZXN0Iiwic2Vzc2lvbiIsImtlZXBhbGl2ZSIsImV4cGlyeVRpbWUiLCJEYXRlIiwibm93IiwidHRsIiwiYXV0aEhlYWRlcnNGcm9tQ29va2llIiwiYnVpbGRBdXRoSGVhZGVyRnJvbUNvb2tpZSIsIm11bHRpdGVuYW5jeSIsImVuYWJsZWQiLCJyZXNvbHZlVGVuYW50IiwiYmFkUmVxdWVzdCIsInNlY3VyaXR5dGVuYW50IiwiVW5hdXRoZW50aWNhdGVkRXJyb3IiLCJyZXF1ZXN0SGVhZGVycyIsIlNlY3VyaXR5Q2xpZW50IiwidHlwZSIsIlJPVVRFU19UT19JR05PUkUiLCJpbmNsdWRlcyIsImF1dGgiLCJ1bmF1dGhlbnRpY2F0ZWRfcm91dGVzIiwiaW5kZXhPZiIsImF1dGhIZWFkZXIiLCJzZWxlY3RlZFRlbmFudCIsInVzZXJfbmFtZSIsInRlbmFudHMiLCJpc1BhZ2VSZXF1ZXN0IiwicGF0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQThCQTs7QUFDQTs7QUFLQTs7OztBQWdCTyxNQUFlQSxrQkFBZixDQUFpRTtBQVl0RUMsRUFBQUEsV0FBVyxDQUNVQyxNQURWLEVBRVVDLHFCQUZWLEVBR1VDLE1BSFYsRUFJVUMsUUFKVixFQUtVQyxTQUxWLEVBTVVDLE1BTlYsRUFPVDtBQUFBLFNBTm1CTCxNQU1uQixHQU5tQkEsTUFNbkI7QUFBQSxTQUxtQkMscUJBS25CLEdBTG1CQSxxQkFLbkI7QUFBQSxTQUptQkMsTUFJbkIsR0FKbUJBLE1BSW5CO0FBQUEsU0FIbUJDLFFBR25CLEdBSG1CQSxRQUduQjtBQUFBLFNBRm1CQyxTQUVuQixHQUZtQkEsU0FFbkI7QUFBQSxTQURtQkMsTUFDbkIsR0FEbUJBLE1BQ25COztBQUFBOztBQUFBOztBQUFBLHlDQUswQyxPQUFPQyxPQUFQLEVBQWdCQyxRQUFoQixFQUEwQkMsT0FBMUIsS0FBc0M7QUFBQTs7QUFDaEY7QUFDQSxVQUFJLEtBQUtDLGVBQUwsQ0FBcUJILE9BQXJCLENBQUosRUFBbUM7QUFDakMsZUFBT0UsT0FBTyxDQUFDRSxhQUFSLEVBQVA7QUFDRCxPQUorRSxDQU1oRjtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQSxZQUFNQyxXQUFXLEdBQUcsRUFBcEI7QUFDQSxVQUFJQyxNQUFKO0FBQ0EsVUFBSUMsUUFBSixDQWJnRixDQWNoRjtBQUNBOztBQUNBLFVBQUksS0FBS0MsdUJBQUwsQ0FBNkJSLE9BQTdCLENBQUosRUFBMkM7QUFDekMsWUFBSTtBQUNGLGdCQUFNUyxtQkFBbUIsR0FBRyxLQUFLQyx1QkFBTCxDQUE2QlYsT0FBN0IsQ0FBNUI7QUFDQVcsVUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWNQLFdBQWQsRUFBMkJJLG1CQUEzQjtBQUNBRixVQUFBQSxRQUFRLEdBQUcsTUFBTSxLQUFLTSxjQUFMLENB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QnhELE9BRHFCLEVBRXJCTyxRQUFRLENBQUNrRCxTQUZZLEVBR3JCbEQsUUFBUSxDQUFDbUQsT0FIWSxFQUlyQixLQUFLaEUsTUFKZ0IsRUFLckJZLE1BTHFCLENBQXZCO0FBT0EsV0FBT2tELGNBQVA7QUFDRDs7QUFFREcsRUFBQUEsYUFBYSxDQUFDM0QsT0FBRCxFQUF5QjtBQUNwQyxVQUFNNEQsSUFBSSxHQUFHNUQsT0FBTyxDQUFDNEIsR0FBUixDQUFZQyxRQUFaLElBQXdCLEdBQXJDO0FBQ0EsV0FBTytCLElBQUksQ0FBQzlCLFVBQUwsQ0FBZ0IsT0FBaEIsS0FBNEI4QixJQUFJLEtBQUssR0FBckMsSUFBNENBLElBQUksQ0FBQzlCLFVBQUwsQ0FBZ0IsUUFBaEIsQ0FBbkQ7QUFDRCxHQWpMcUUsQ0FtTHRFOzs7QUFuTHNFOzs7O2dCQUFsRHRDLGtCLHNCQUNtQyxDQUNyRCx3QkFEcUQsRUFDM0I7QUFDMUIsWUFGcUQsQzs7Z0JBRG5DQSxrQiwwQkFNNkIsVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiAgIENvcHlyaWdodCAyMDIwIEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogICBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiAgIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogICBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqICAgb24gYW4gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyXG4gKiAgIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiAgIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQge1xuICBBdXRoZW50aWNhdGlvbkhhbmRsZXIsXG4gIFNlc3Npb25TdG9yYWdlRmFjdG9yeSxcbiAgSUxlZ2FjeUNsdXN0ZXJDbGllbnQsXG4gIElSb3V0ZXIsXG4gIENvcmVTZXR1cCxcbiAgTG9nZ2VyLFxuICBBdXRoVG9vbGtpdCxcbiAgTGlmZWN5Y2xlUmVzcG9uc2VGYWN0b3J5LFxuICBLaWJhbmFSZXF1ZXN0LFxuICBJS2liYW5hUmVzcG9uc2UsXG4gIEF1dGhSZXN1bHQsXG59IGZyb20gJ2tpYmFuYS9zZXJ2ZXInO1xuaW1wb3J0IHsgU2VjdXJpdHlQbHVnaW5Db25maWdUeXBlIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHsgU2VjdXJpdHlTZXNzaW9uQ29va2llIH0gZnJvbSAnLi4vLi4vc2Vzc2lvbi9zZWN1cml0eV9jb29raWUnO1xuaW1wb3J0IHsgU2VjdXJpdHlDbGllbnQgfSBmcm9tICcuLi8uLi9iYWNrZW5kL29wZW5kaXN0cm9fc2VjdXJpdHlfY2xpZW50JztcbmltcG9ydCB7XG4gIGlzTXVsdGl0ZW5hbnRQYXRoLFxuICByZXNvbHZlVGVuYW50LFxuICBpc1ZhbGlkVGVuYW50LFxufSBmcm9tICcuLi8uLi9tdWx0aXRlbmFuY3kvdGVuYW50X3Jlc29sdmVyJztcbmltcG9ydCB7IFVuYXV0aGVudGljYXRlZEVycm9yIH0gZnJvbSAnLi4vLi4vZXJyb3JzJztcblxuZXhwb3J0IGludGVyZmFjZSBJQXV0aGVudGljYXRpb25UeXBlIHtcbiAgdHlwZTogc3RyaW5nO1xuICBhdXRoSGFuZGxlcjogQXV0aGVudGljYXRpb25IYW5kbGVyO1xufVxuXG5leHBvcnQgdHlwZSBJQXV0aEhhbmRsZXJDb25zdHJ1Y3RvciA9IG5ldyAoXG4gIGNvbmZpZzogU2VjdXJpdHlQbHVnaW5Db25maWdUeXBlLFxuICBzZXNzaW9uU3RvcmFnZUZhY3Rvcnk6IFNlc3Npb25TdG9yYWdlRmFjdG9yeTxTZWN1cml0eVNlc3Npb25Db29raWU+LFxuICByb3V0ZXI6IElSb3V0ZXIsXG4gIGVzQ2xpZW50OiBJTGVnYWN5Q2x1c3RlckNsaWVudCxcbiAgY29yZVNldHVwOiBDb3JlU2V0dXAsXG4gIGxvZ2dlcjogTG9nZ2VyXG4pID0+IElBdXRoZW50aWNhdGlvblR5cGU7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBBdXRoZW50aWNhdGlvblR5cGUgaW1wbGVtZW50cyBJQXV0aGVudGljYXRpb25UeXBlIHtcbiAgcHJvdGVjdGVkIHN0YXRpYyByZWFkb25seSBST1VURVNfVE9fSUdOT1JFOiBzdHJpbmdbXSA9IFtcbiAgICAnL2FwaS9jb3JlL2NhcGFiaWxpdGllcycsIC8vIEZJWE1FOiBuZWVkIHRvIGZpZ3VyZW91dCBob3cgdG8gYnlwYXNzIHRoaXMgQVBJIGNhbGxcbiAgICAnL2FwcC9sb2dpbicsXG4gIF07XG5cbiAgcHJvdGVjdGVkIHN0YXRpYyByZWFkb25seSBSRVNUX0FQSV9DQUxMX0hFQURFUiA9ICdrYm4teHNyZic7XG5cbiAgcHVibGljIHR5cGU6IHN0cmluZztcblxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgc2VjdXJpdHlDbGllbnQ6IFNlY3VyaXR5Q2xpZW50O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCByZWFkb25seSBjb25maWc6IFNlY3VyaXR5UGx1Z2luQ29uZmlnVHlwZSxcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgc2Vzc2lvblN0b3JhZ2VGYWN0b3J5OiBTZXNzaW9uU3RvcmFnZUZhY3Rvcnk8U2VjdXJpdHlTZXNzaW9uQ29va2llPixcbiAgICBwcm90ZWN0ZWQgcmVhZG9ubHkgcm91dGVyOiBJUm91dGVyLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBlc0NsaWVudDogSUxlZ2FjeUNsdXN0ZXJDbGllbnQsXG4gICAgcHJvdGVjdGVkIHJlYWRvbmx5IGNvcmVTZXR1cDogQ29yZVNldHVwLFxuICAgIHByb3RlY3RlZCByZWFkb25seSBsb2dnZXI6IExvZ2dlclxuICApIHtcbiAgICB0aGlzLnNlY3VyaXR5Q2xpZW50ID0gbmV3IFNlY3VyaXR5Q2xpZW50KGVzQ2xpZW50KTtcbiAgICB0aGlzLnR5cGUgPSAnJztcbiAgfVxuXG4gIHB1YmxpYyBhdXRoSGFuZGxlcjogQXV0aGVudGljYXRpb25IYW5kbGVyID0gYXN5bmMgKHJlcXVlc3QsIHJlc3BvbnNlLCB0b29sa2l0KSA9PiB7XG4gICAgLy8gc2tpcCBhdXRoIGZvciBBUElzIHRoYXQgZG8gbm90IHJlcXVpcmUgYXV0aFxuICAgIGlmICh0aGlzLmF1dGhOb3RSZXF1aXJlZChyZXF1ZXN0KSkge1xuICAgICAgcmV0dXJuIHRvb2xraXQuYXV0aGVudGljYXRlZCgpO1xuICAgIH1cblxuICAgIC8vIGlmIGJyb3dzZXIgcmVxdWVzdCwgYXV0aCBsb2dpYyBpczpcbiAgICAvLyAgIDEuIGNoZWNrIGlmIHJlcXVlc3QgaW5jbHVkZXMgYXV0aCBoZWFkZXIgb3IgcGFyYW10ZXIoZS5nLiBqd3QgaW4gdXJsIHBhcmFtcykgaXMgcHJlc2VudCwgaWYgc28sIGF1dGhlbnRpY2F0ZSB3aXRoIGF1dGggaGVhZGVyLlxuICAgIC8vICAgMi4gaWYgYXV0aCBoZWFkZXIgbm90IHByZXNlbnQsIGNoZWNrIGlmIGF1dGggY29va2llIGlzIHByZXNlbnQsIGlmIG5vIGNvb2tpZSwgc2VuZCB0byBhdXRoZW50aWNhdGlvbiB3b3JrZmxvd1xuICAgIC8vICAgMy4gdmVyaWZ5IHdoZXRoZXIgYXV0aCBjb29raWUgaXMgdmFsaWQsIGlmIG5vdCB2YWxpZCwgc2VuZCB0byBhdXRoZW50aWNhdGlvbiB3b3JrZmxvd1xuICAgIC8vICAgNC4gaWYgY29va2llIGlzIHZhbGlkLCBwYXNzIHRvIHJvdXRlIGhhbmRsZXJzXG4gICAgY29uc3QgYXV0aEhlYWRlcnMgPSB7fTtcbiAgICBsZXQgY29va2llOiBTZWN1cml0eVNlc3Npb25Db29raWUgfCBudWxsIHwgdW5kZWZpbmVkO1xuICAgIGxldCBhdXRoSW5mbzogYW55IHwgdW5kZWZpbmVkO1xuICAgIC8vIGlmIHRoaXMgaXMgYW4gUkVTVCBBUEkgY2FsbCwgc3VwcG9zZSB0aGUgcmVxdWVzdCBpbmNsdWRlcyBuZWNlc3NhcnkgYXV0aCBoZWFkZXJcbiAgICAvLyBzZWUgaHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9raWJhbmEvbWFzdGVyL3VzaW5nLWFwaS5odG1sXG4gICAgaWYgKHRoaXMucmVxdWVzdEluY2x1ZGVzQXV0aEluZm8ocmVxdWVzdCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGFkZGl0b25hbEF1dGhIZWFkZXIgPSB0aGlzLmdldEFkZGl0aW9uYWxBdXRoSGVhZGVyKHJlcXVlc3QpO1xuICAgICAgICBPYmplY3QuYXNzaWduKGF1dGhIZWFkZXJzLCBhZGRpdG9uYWxBdXRoSGVhZGVyKTtcbiAgICAgICAgYXV0aEluZm8gPSBhd2FpdCB0aGlzLnNlY3VyaXR5Q2xpZW50LmF1dGhpbmZvKHJlcXVlc3QsIGFkZGl0b25hbEF1dGhIZWFkZXIpO1xuICAgICAgICBjb29raWUgPSBhd2FpdCB0aGlzLmdldENvb2tpZShyZXF1ZXN0LCBhdXRoSW5mbyk7XG5cbiAgICAgICAgLy8gc2V0IHRlbmFudCBmcm9tIGNvb2tpZSBpZiBleGlzdFxuICAgICAgICBjb25zdCBicm93c2VyQ29va2llID0gYXdhaXQgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuZ2V0KCk7XG4gICAgICAgIGlmIChicm93c2VyQ29va2llICYmIGlzVmFsaWRUZW5hbnQoYnJvd3NlckNvb2tpZS50ZW5hbnQpKSB7XG4gICAgICAgICAgY29va2llLnRlbmFudCA9IGJyb3dzZXJDb29raWUudGVuYW50O1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuc2V0KGNvb2tpZSk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICByZXR1cm4gcmVzcG9uc2UudW5hdXRob3JpemVkKHtcbiAgICAgICAgICBib2R5OiBlcnJvci5tZXNzYWdlLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbm8gYXV0aCBoZWFkZXIgaW4gcmVxdWVzdCwgdHJ5IGNvb2tpZVxuICAgICAgdHJ5IHtcbiAgICAgICAgY29va2llID0gYXdhaXQgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuZ2V0KCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihgRXJyb3IgcGFyc2luZyBjb29raWU6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgY29va2llID0gdW5kZWZpbmVkO1xuICAgICAgfVxuXG4gICAgICBpZiAoIWNvb2tpZSB8fCAhKGF3YWl0IHRoaXMuaXNWYWxpZENvb2tpZShjb29raWUpKSkge1xuICAgICAgICAvLyBjbGVhciBjb29raWVcbiAgICAgICAgdGhpcy5zZXNzaW9uU3RvcmFnZUZhY3RvcnkuYXNTY29wZWQocmVxdWVzdCkuY2xlYXIoKTtcblxuICAgICAgICAvLyBmb3IgYXNzZXRzLCB3ZSBjYW4gc3RpbGwgcGFzcyBpdCB0byByZXNvdXJjZSBoYW5kbGVyIGFzIG5vdEhhbmRsZWQuXG4gICAgICAgIC8vIG1hcmtpbmcgaXQgYXMgYXV0aGVudGljYXRlZCBtYXkgcmVzdWx0IGluIGxvZ2luIHBvcCB1cCB3aGVuIGF1dGggY2hhbGxlbmdlXG4gICAgICAgIC8vIGlzIGVuYWJsZWQuXG4gICAgICAgIGlmIChyZXF1ZXN0LnVybC5wYXRobmFtZSAmJiByZXF1ZXN0LnVybC5wYXRobmFtZS5zdGFydHNXaXRoKCcvYnVuZGxlcy8nKSkge1xuICAgICAgICAgIHJldHVybiB0b29sa2l0Lm5vdEhhbmRsZWQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHNlbmQgdG8gYXV0aCB3b3JrZmxvd1xuICAgICAgICByZXR1cm4gdGhpcy5oYW5kbGVVbmF1dGhlZFJlcXVlc3QocmVxdWVzdCwgcmVzcG9uc2UsIHRvb2xraXQpO1xuICAgICAgfVxuXG4gICAgICAvLyBleHRlbmQgc2Vzc2lvbiBleHBpcmF0aW9uIHRpbWVcbiAgICAgIGlmICh0aGlzLmNvbmZpZy5zZXNzaW9uLmtlZXBhbGl2ZSkge1xuICAgICAgICBjb29raWUhLmV4cGlyeVRpbWUgPSBEYXRlLm5vdygpICsgdGhpcy5jb25maWcuc2Vzc2lvbi50dGw7XG4gICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2VGYWN0b3J5LmFzU2NvcGVkKHJlcXVlc3QpLnNldChjb29raWUhKTtcbiAgICAgIH1cbiAgICAgIC8vIGNvb2tpZSBpcyB2YWxpZFxuICAgICAgLy8gYnVpbGQgYXV0aCBoZWFkZXJcbiAgICAgIGNvbnN0IGF1dGhIZWFkZXJzRnJvbUNvb2tpZSA9IHRoaXMuYnVpbGRBdXRoSGVhZGVyRnJvbUNvb2tpZShjb29raWUhKTtcbiAgICAgIE9iamVjdC5hc3NpZ24oYXV0aEhlYWRlcnMsIGF1dGhIZWFkZXJzRnJvbUNvb2tpZSk7XG4gICAgICBjb25zdCBhZGRpdG9uYWxBdXRoSGVhZGVyID0gdGhpcy5nZXRBZGRpdGlvbmFsQXV0aEhlYWRlcihyZXF1ZXN0KTtcbiAgICAgIE9iamVjdC5hc3NpZ24oYXV0aEhlYWRlcnMsIGFkZGl0b25hbEF1dGhIZWFkZXIpO1xuICAgIH1cblxuICAgIC8vIHJlc29sdmUgdGVuYW50IGlmIG5lY2Vzc2FyeVxuICAgIGlmICh0aGlzLmNvbmZpZy5tdWx0aXRlbmFuY3k/LmVuYWJsZWQgJiYgaXNNdWx0aXRlbmFudFBhdGgocmVxdWVzdCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHRlbmFudCA9IGF3YWl0IHRoaXMucmVzb2x2ZVRlbmFudChyZXF1ZXN0LCBjb29raWUhLCBhdXRoSGVhZGVycywgYXV0aEluZm8pO1xuICAgICAgICAvLyByZXR1cm4gNDAxIGlmIG5vIHRlbmFudCBhdmFpbGFibGVcbiAgICAgICAgaWYgKCFpc1ZhbGlkVGVuYW50KHRlbmFudCkpIHtcbiAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuYmFkUmVxdWVzdCh7XG4gICAgICAgICAgICBib2R5OlxuICAgICAgICAgICAgICAnTm8gYXZhaWxhYmxlIHRlbmFudCBmb3IgY3VycmVudCB1c2VyLCBwbGVhc2UgcmVhY2ggb3V0IHRvIHlvdXIgc3lzdGVtIGFkbWluaXN0cmF0b3InLFxuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIC8vIHNldCB0ZW5hbnQgaW4gaGVhZGVyXG4gICAgICAgIE9iamVjdC5hc3NpZ24oYXV0aEhlYWRlcnMsIHsgc2VjdXJpdHl0ZW5hbnQ6IHRlbmFudCB9KTtcblxuICAgICAgICAvLyBzZXQgdGVuYW50IHRvIGNvb2tpZVxuICAgICAgICBpZiAodGVuYW50ICE9PSBjb29raWUhLnRlbmFudCkge1xuICAgICAgICAgIGNvb2tpZSEudGVuYW50ID0gdGVuYW50O1xuICAgICAgICAgIHRoaXMuc2Vzc2lvblN0b3JhZ2VGYWN0b3J5LmFzU2NvcGVkKHJlcXVlc3QpLnNldChjb29raWUhKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYEZhaWxlZCB0byByZXNvbHZlIHVzZXIgdGVuYW50OiAke2Vycm9yfWApO1xuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBVbmF1dGhlbnRpY2F0ZWRFcnJvcikge1xuICAgICAgICAgIGlmIChyZXF1ZXN0LnVybC5wYXRobmFtZSAmJiByZXF1ZXN0LnVybC5wYXRobmFtZS5zdGFydHNXaXRoKCcvYnVuZGxlcy8nKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRvb2xraXQubm90SGFuZGxlZCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aGlzLnNlc3Npb25TdG9yYWdlRmFjdG9yeS5hc1Njb3BlZChyZXF1ZXN0KS5jbGVhcigpO1xuICAgICAgICAgIHJldHVybiB0aGlzLmhhbmRsZVVuYXV0aGVkUmVxdWVzdChyZXF1ZXN0LCByZXNwb25zZSwgdG9vbGtpdCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRvb2xraXQuYXV0aGVudGljYXRlZCh7XG4gICAgICByZXF1ZXN0SGVhZGVyczogYXV0aEhlYWRlcnMsXG4gICAgfSk7XG4gIH07XG5cbiAgYXV0aE5vdFJlcXVpcmVkKHJlcXVlc3Q6IEtpYmFuYVJlcXVlc3QpOiBib29sZWFuIHtcbiAgICBjb25zdCBwYXRobmFtZSA9IHJlcXVlc3QudXJsLnBhdGhuYW1lO1xuICAgIGlmICghcGF0aG5hbWUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgLy8gYWxsb3cgcmVxdWVzdHMgdG8gaWdub3JlZCByb3V0ZXNcbiAgICBpZiAoQXV0aGVudGljYXRpb25UeXBlLlJPVVRFU19UT19JR05PUkUuaW5jbHVkZXMocGF0aG5hbWUhKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIC8vIGFsbG93IHJlcXVlc3RzIHRvIHJvdXRlcyB0aGF0IGRvZXNuJ3QgcmVxdWlyZSBhdXRoZW50aWNhdGlvblxuICAgIGlmICh0aGlzLmNvbmZpZy5hdXRoLnVuYXV0aGVudGljYXRlZF9yb3V0ZXMuaW5kZXhPZihwYXRobmFtZSEpID4gLTEpIHtcbiAgICAgIC8vIFRPRE86IHVzZSBraWJhbmEgc2VydmVyIHVzZXJcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBhc3luYyByZXNvbHZlVGVuYW50KFxuICAgIHJlcXVlc3Q6IEtpYmFuYVJlcXVlc3QsXG4gICAgY29va2llOiBTZWN1cml0eVNlc3Npb25Db29raWUsXG4gICAgYXV0aEhlYWRlcjogYW55LFxuICAgIGF1dGhJbmZvOiBhbnlcbiAgKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIWF1dGhJbmZvKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhdXRoSW5mbyA9IGF3YWl0IHRoaXMuc2VjdXJpdHlDbGllbnQuYXV0aGluZm8ocmVxdWVzdCwgYXV0aEhlYWRlcik7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBuZXcgVW5hdXRoZW50aWNhdGVkRXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHNlbGVjdGVkVGVuYW50ID0gcmVzb2x2ZVRlbmFudChcbiAgICAgIHJlcXVlc3QsXG4gICAgICBhdXRoSW5mby51c2VyX25hbWUsXG4gICAgICBhdXRoSW5mby50ZW5hbnRzLFxuICAgICAgdGhpcy5jb25maWcsXG4gICAgICBjb29raWVcbiAgICApO1xuICAgIHJldHVybiBzZWxlY3RlZFRlbmFudDtcbiAgfVxuXG4gIGlzUGFnZVJlcXVlc3QocmVxdWVzdDogS2liYW5hUmVxdWVzdCkge1xuICAgIGNvbnN0IHBhdGggPSByZXF1ZXN0LnVybC5wYXRobmFtZSB8fCAnLyc7XG4gICAgcmV0dXJuIHBhdGguc3RhcnRzV2l0aCgnL2FwcC8nKSB8fCBwYXRoID09PSAnLycgfHwgcGF0aC5zdGFydHNXaXRoKCcvZ290by8nKTtcbiAgfVxuXG4gIC8vIGFic3RyYWN0IGZ1bmN0aW9ucyBmb3IgY29uY3JldGUgYXV0aCB0eXBlcyB0byBpbXBsZW1lbnRcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHJlcXVlc3RJbmNsdWRlc0F1dGhJbmZvKHJlcXVlc3Q6IEtpYmFuYVJlcXVlc3QpOiBib29sZWFuO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0QWRkaXRpb25hbEF1dGhIZWFkZXIocmVxdWVzdDogS2liYW5hUmVxdWVzdCk6IGFueTtcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldENvb2tpZShyZXF1ZXN0OiBLaWJhbmFSZXF1ZXN0LCBhdXRoSW5mbzogYW55KTogU2VjdXJpdHlTZXNzaW9uQ29va2llO1xuICBwcm90ZWN0ZWQgYWJzdHJhY3QgYXN5bmMgaXNWYWxpZENvb2tpZShjb29raWU6IFNlY3VyaXR5U2Vzc2lvbkNvb2tpZSk6IFByb21pc2U8Ym9vbGVhbj47XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBoYW5kbGVVbmF1dGhlZFJlcXVlc3QoXG4gICAgcmVxdWVzdDogS2liYW5hUmVxdWVzdCxcbiAgICByZXNwb25zZTogTGlmZWN5Y2xlUmVzcG9uc2VGYWN0b3J5LFxuICAgIHRvb2xraXQ6IEF1dGhUb29sa2l0XG4gICk6IElLaWJhbmFSZXNwb25zZSB8IEF1dGhSZXN1bHQ7XG4gIHByb3RlY3RlZCBhYnN0cmFjdCBidWlsZEF1dGhIZWFkZXJGcm9tQ29va2llKGNvb2tpZTogU2VjdXJpdHlTZXNzaW9uQ29va2llKTogYW55O1xufVxuIl19